sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment"],function(e,t,s,i,n,o){"use strict";return e.extend("com.coil.podway.MAACDE.controller.Worklist",{formatter:s,onInit:function(){var e,s=this;this._aTableSearchState=[];var i;switch(this.getOwnerComponent().sAccType){case 1:i=this.getResourceBundle().getText("Device");break;case 2:i=this.getResourceBundle().getText("Condition");break;case 3:i=this.getResourceBundle().getText("Place")}e=new t({bDeviceItemsBusy:false,bEditQuestion:false,saveAsTileTitle:this.getResourceBundle().getText("saveAsTileTitle",this.getResourceBundle().getText("worklistViewTitle")),shareOnJamTitle:this.getResourceBundle().getText("worklistTitle"),shareSendEmailSubject:this.getResourceBundle().getText("shareSendEmailWorklistSubject"),shareSendEmailMessage:this.getResourceBundle().getText("shareSendEmailWorklistMessage",[location.href]),tableBusyDelay:0,appType:i});this.setModel(e,"worklistView");this.addHistoryEntry({title:this.getResourceBundle().getText("worklistViewTitle"),icon:"sap-icon://wrench",intent:this.getIntent(this.getOwnerComponent().sAccType)},true);this.getOwnerComponent().getModel().metadataLoaded().then(s._fnInitialBindings.bind(s))},onAfterRendering:function(){this._initMessage()},_initMessage:function(){var e=this.getModel("worklistView");this._oMessageManager=sap.ui.getCore().getMessageManager();this._oMessageManager.registerMessageProcessor(e)},getIntent:function(e){var t;switch(e){case 1:t="#Manage-Device";break;case 2:t="#Manage-Condition";break;case 3:t="#Manage-Place"}return t},_fnInitialBindings:function(){var e=this.getView().getContent()[0].getTitle(),t=this.getView().byId("gdAccItems"),s=this.getOwnerComponent().getModel();s.read("/AccessibilitySet",{filters:[new i("Type",n.EQ,this._getAccName(this.getOwnerComponent().sAccType))],success:function(t){var i=s.createKey("/AccessibilitySet",{Id:t.results[0].Id});e.bindElement(i)}});var o=t.getContent()[0].clone();t.bindAggregation("content",{template:o,path:"/AccessibilityItemSet",events:{dataRequested:this._fnbusyItems.bind(this),dataReceived:this._fnbusyItems.bind(this)},filters:[new i("AccessibilityId",n.EQ,this.getOwnerComponent().sAccType),new i("IsArchived",n.EQ,false)],templateShareable:true})},onEditQuestion:function(e){this._oMessageManager.removeAllMessages();if(e){var t=this.getModel().getProperty("Question",e.getSource().getBindingContext()),s=this.getModel().getProperty("Heading",e.getSource().getBindingContext());this.getModel("worklistView").setProperty("/sQuestion",t);this.getModel("worklistView").setProperty("/sHeading",s)}var i=this.getModel("worklistView").getProperty("/bEditQuestion");this.getModel("worklistView").setProperty("/bEditQuestion",!i)},isValid:function(e,t){this._oMessageManager.removeAllMessages();var s=[],i={status:true,aMsg:[]};if(e.length===0){s.push({message:"ERR_QUESTION",target:"/sQuestion"});i.status=false;i.aMsg.push("ERR_QUESTION")}if(t.length===0){s.push({message:"ERR_HEADING",target:"/sHeading"});i.status=false;i.aMsg.push("ERR_HEADING")}if(s.length)this._GenCtrlMessages(s);return i},onSaveQuestion:function(){var e=this.getModel("worklistView").getProperty("/sQuestion"),t=this.getModel("worklistView").getProperty("/sHeading"),s=this;var i=this.isValid(e,t);if(!i.status){s._ErrorBox(s._fnMsgConcatinator(i.aMsg));return}var n=this.getView().byId("ipTitle").getBindingContext().getPath();this.getModel().update(n,{Question:e,Heading:t},{success:function(){this.onEditQuestion();this._fnSuccessToast("MSG_SUCCESS_TITLE_UPDATE")}.bind(s)})},onAddOption:function(){var e=this;e.getModel("worklistView").setProperty("/oAddOption",{Title:"",AccessibilityId:this.getOwnerComponent().sAccType,Icon:null,TextAllowed:false,IsEnabled:false,Information:""});e.getModel("worklistView").setProperty("/sDialogMode","C");e._DeviceAccessibilityDialog()},onCancelAddOption:function(){this.byId("updAddOptn").setValue(null);this._oDlgAddOption.close()},onShareInJamPress:function(){var e=this.getModel("worklistView"),t=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:location.href,share:e.getProperty("/shareOnJamTitle")}}});t.open()},onSaveAddOption:function(){var e=this._oDlgAddOption.getContent()[1].getImageEditor();if(this._bNotValid(e)){return}e.getImageAsBlob().then(this._imageBlob.bind(this))},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh()}else{var t=[];var s=e.getParameter("query");if(s&&s.length>0){t=[new i("Question",n.Contains,s)]}this._applySearch(t)}},onFileChange:function(e){var t=e.getParameter("files")[0];if(!t){return}this.getModel("worklistView").setProperty("/oAddOption/Icon",t)},onImageLoaded:function(e){var t=e.getSource();if(this.getModel("worklistView").getProperty("/oAddOption/Icon")){setTimeout(function(){t.zoomToFit()},2e3)}},onDevice:function(e){var t=e.getSource().getType(),s=e.getSource().getBindingContext().getPath(),i=this;if(t==="Reject"){var n={};switch(i.getOwnerComponent().sAccType){case 1:n.warn="MSG_CONFIRM_REMOVE_DEVICEITEM";n.succ="MSG_SUCCESS_DEVICE_REMOVE";break;case 2:n.warn="MSG_CONFIRM_REMOVE_CONDITION";n.succ="MSG_SUCCESS_CONDITION_REMOVE";break;case 3:n.warn="MSG_CONFIRM_REMOVE_PLACE";n.succ="MSG_SUCCESS_PLACE_REMOVE"}this._fnWarningMessageBox(n.warn,function(){i.getModel().update(s,{IsArchived:true},{success:i._fnSuccessToast.bind(i,n.succ)})})}else{var o=$.extend(true,{},e.getSource().getBindingContext().getObject()),a=new URL(o.__metadata.media_src);o.Icon="/EXPO_PODIUM_API"+a.pathname;i.getModel("worklistView").setProperty("/oAddOption",o);i.getModel("worklistView").setProperty("/sDialogMode","E");i._DeviceAccessibilityDialog()}},_fnbusyItems:function(e){var t=this.getModel("worklistView");if(e.getId()==="dataRequested"){t.setProperty("/bDeviceItemsBusy",true)}else{t.setProperty("/bDeviceItemsBusy",false)}},_DeviceAccessibilityDialog:function(){this._oMessageManager.removeAllMessages();var e=this.getView(),t=this;if(!t._oDlgAddOption){o.load({id:e.getId(),name:"com.coil.podway.MAACDE.dialog.AddOption",controller:t}).then(function(s){t._oDlgAddOption=s;e.addDependent(s);s.open()})}else{t._oDlgAddOption.open()}},_bNotValid:function(e){var t=false;this._oMessageManager.removeAllMessages();var s=[];if(this.getModel("worklistView").getProperty("/oAddOption/Title").length===0){s.push({message:"MSG_ERR_TITLE",target:"/oAddOption/Title"});this._fnSuccessToast("MSG_ERR_TITLE");t=true}if(!e.getLoaded()&&!t){this._fnSuccessToast("MSG_ERR_IMAGE");t=true}if(s.length)this._GenCtrlMessages(s);if(this._oMessageManager.getMessageModel().getData().length>0){t=true}return t},_GenCtrlMessages:function(e){var t=this;e.forEach(function(e){t._oMessageManager.addMessages(new sap.ui.core.message.Message({message:t.getResourceBundle().getText(e.message),type:sap.ui.core.MessageType.Error,target:e.target,processor:t.getModel("worklistView"),persistent:true}))})},getImageEditorControl:function(e){return e.getParent().getImageEditor()},_imageBlob:function(e){this._fnCreateOption().then(this._uplaodImage.bind(this,e))},_uplaodImage:function(e,t){var s=new URL(t.__metadata.media_src),i=this.getModel("worklistView"),n=this,o={url:"/EXPO_PODIUM_API"+s.pathname,data:e,method:"PUT",headers:this.getModel().getHeaders(),contentType:"multipart/form-data",processData:false,success:function(){var e=i.getProperty("/sDialogMode")==="C"?"MSG_SUCCESS_OPTION_CREATE":"MSG_SUCCESS_EDIT";n._fnCreateOptionSuccess.call(n,e);n.getModel().refresh(true)},error:function(){n._fnSuccessToast.call(n,"MSG_ERR_IMAGE_UPLOAD")}};$.ajax(o).always(function(){i.setProperty("/bBusyDialog",false)})},getImageBinary:function(){var e=this.getModel("worklistView").getProperty("/oAddOption/Icon"),t=new FileReader;return new Promise(function(s,i){if(!(e instanceof File)){s(e);return}t.onload=function(){s(t.result)};t.readAsDataURL(e)})},_fnCreateOption:function(e){var t=this.getModel("worklistView"),s=this,i=t.getProperty("/oAddOption");t.setProperty("/bBusyDialog",true);delete i.Icon;return new Promise(function(e,n){if(t.getProperty("/sDialogMode")==="C"){s.getModel().create("/AccessibilityItemSet",i,{success:function(t){e(t)},error:function(){n.call(s)}})}else{var o=s.getModel().createKey("/AccessibilityItemSet",{Id:i.Id});s.getModel().update(o,i,{success:function(t){e(i)},error:function(){n()}})}})},_fnCreateOptionSuccess:function(e){this.onCancelAddOption();this._fnSuccessToast(e)},_fnMsgConcatinator:function(e){var t=this;return e.map(function(e){return t.getResourceBundle().getText(e)}).join("\n")}})});