sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/m/MessageToast"],function(e,t,s,a,i,r,o){"use strict";return e.extend("com.coil.podway.MDM_Data.controller.Object",{formatter:s,onInit:function(){var e,s=new t({busy:true,delay:0});this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.getRouter().getRoute("createObject").attachPatternMatched(this._onCreateObjectMatched,this);e=this.getView().getBusyIndicatorDelay();this.setModel(s,"objectView");debugger;var a=sap.ui.getCore().getConfiguration().getLanguage();var i=a.substring(0,2);this.getModel("objectView").setProperty("/loggedInLanguage",i);this.getModel("objectView").setProperty("/languageAr","ar");this.getOwnerComponent().getModel().metadataLoaded().then(function(){s.setProperty("/delay",e)})},onShareInJamPress:function(){var e=this.getModel("objectView"),t=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:location.href,share:e.getProperty("/shareOnJamTitle")}}});t.open()},onAfterRendering:function(){this._initMessage()},_initMessage:function(){var e=this.getModel("objectView");this._oMessageManager=sap.ui.getCore().getMessageManager();this._oMessageManager.registerMessageProcessor(e)},_onObjectMatched:function(e){this.getModel("objectView").setProperty("/sMode","E");this.getModel("objectView").setProperty("/busy",true);var t=e.getParameter("arguments").objectId;this.getModel("objectView").setProperty("/parentId",t);var s=parseInt(t);var r=this.getView().byId("table");var o=[new a("ParentId",i.EQ,s),new a("IsArchived",i.EQ,false),new a("IsChild",i.EQ,true)];var n=new sap.m.ColumnListItem({cells:[new sap.m.Image({width:"2rem",class:"sapUiTinyMargin",height:"2rem",src:{path:"__metadata",formatter:this.formatter.giveImage}}),new sap.m.Label({text:"{ServiceType}"}),new sap.m.Label({text:"{ServiceMessage}"}),new sap.m.Label({text:"{ContactNumber}",textDirection:"LTR"}),new sap.m.CheckBox({selected:"{IsCancelable}",editable:false}),new sap.m.ObjectStatus({text:"{IncidentType/IncidentType}",state:"{= ${IncidentType/IncidentType} === 'Emergency' ? 'Error' : 'Success' }"}),new sap.m.Label({text:"{Navigation/NavigationTypeName}"}),new sap.m.Button({icon:"sap-icon://edit",type:"Transparent",press:this.onEdit.bind(this)}),new sap.m.Button({icon:"sap-icon://delete",type:"Transparent",press:this.onDeleteChild.bind(this)})]});r.bindAggregation("items",{path:"/MasterServiceTypeSet",parameters:{expand:"Navigation,IncidentType"},filters:o,template:n,templateShareable:false});this.getModel().metadataLoaded().then(function(){var e=this.getModel().createKey("/MasterServiceTypeSet",{Id:t});this.getModel().read(e,{urlParameters:{$expand:"Navigation,IncidentType"},success:this._setView.bind(this)})}.bind(this))},_onCreateObjectMatched:function(){this.getModel("objectView").setProperty("/sMode","C");this.getModel("objectView").setProperty("/busy",true);this._setView()},_setView:function(e){this._oMessageManager.removeAllMessages();var t=this.getModel("objectView");t.setProperty("/busy",false);this._pendingDelOps=[];if(e){t.setProperty("/oDetails",e);return}t.setProperty("/oDetails",{ServiceType:"",ServiceMessage:"",IncidentTypeId:0,NavigationId:0,ContactNumber:"",IsCancelable:false,IsArchived:false})},onUpload:function(e){var t=e.getSource().FUEl.files[0];this.getImageBinary(t).then(this._fnAddFile.bind(this))},_fnAddFile:function(e){this.getModel("objectView").setProperty("/oImage",{Image:e.Image,FileName:e.name,IsArchived:false});this.getModel("objectView").refresh()},getImageBinary:function(e){var t=new FileReader;var s=e.name;return new Promise(function(a,i){if(!(e instanceof File)){a(e);return}t.onload=function(){a({Image:t.result,name:s})};a({Image:e,name:s})})},onEdit:function(e){var t=this.getModel("objectView"),s=e.getSource().getBindingContext().getObject();t.setProperty("/sChildMode","E");t.setProperty("/oServiceData",s);t.setProperty("/sServicePath",e.getSource().getBindingContext().getPath());var a=this.getView();if(!this.byId("detailsChildDialog")){r.load({id:a.getId(),name:"com.coil.podway.MDM_Data.dialog.Service",controller:this}).then(function(e){a.addDependent(e);e.open()})}else{this.byId("detailsChildDialog").open()}},addChild:function(){var e=this.getModel("objectView");e.setProperty("/oServiceData",{ServiceType:"",ServiceMessage:"",ContactNumber:"",IsCancelable:false,IncidentTypeId:null,NavigationId:null,ParentId:e.getProperty("/parentId"),IsChild:true});e.setProperty("/sChildMode","C");var t=this.getView();if(!this.byId("detailsChildDialog")){r.load({id:t.getId(),name:"com.coil.podium.MDM_Data.dialog.Service",controller:this}).then(function(e){t.addDependent(e);e.open()})}else{this.byId("detailsChildDialog").open()}},onClose:function(e){this.byId("detailsChildDialog").close();this.getModel().refresh(true);this.getModel("objectView").setProperty("/oImage",null)},onDeleteChild:function(e){var t=e.getSource().getBindingContext().getPath();function s(){var e=this.getModel().getData(t);this.getModel().update(t,{ServiceType:e.ServiceType,ServiceMessage:e.ServiceMessage,ContactNumber:e.ContactNumber,IsCancelable:e.IsCancelable,IncidentTypeId:e.IncidentTypeId,NavigationId:e.NavigationId,IsArchived:true},{success:this.showToast.bind(this,"MSG_SUCCESS_SERVICE_REMOVE")})}this.showWarning("MSG_CONFIRM_DELETE",s)},onSaveChild:function(e){this._oMessageManager.removeAllMessages();var t=this.getModel("objectView"),s=t.getProperty("/oServiceData"),a=t.getProperty("/sServicePath");var i=this._fnValidationChild(s);if(i.IsNotValid){this.showError(this._fnMsgConcatinator(i.sMsg));return}var r=parseInt(s.ParentId);if(s.IncidentTypeId===NaN){s.IncidentTypeId=1}s.IncidentTypeId=parseInt(s.IncidentTypeId);s.NavigationId=parseInt(s.NavigationId);s.ParentId=r;delete s.CreatedBy;delete s.UpdatedAt;delete s.UpdatedBy;delete s.CreatedAt;delete s.IncidentType;delete s.Navigation;delete s.__metadata;if(t.getProperty("/sChildMode")==="E"){this.getModel().update(a,s,{success:this._UploadImage(a,t.getProperty("/oImage")).then(this._SuccessChildEdit.bind(this,e),this._Error.bind(this)),error:this._Error.bind(this)})}else{var o=this;a="/MasterServiceTypeSet";this.getModel().create(a,s,{success:function(s){var i=a+"("+s.Id+")";o._UploadImage(i,t.getProperty("/oImage")).then(o._SuccessChildAdd.bind(o,e),o._Error.bind(o))},error:this._Error.bind(this)})}},_fnValidationChild:function(e){var t={IsNotValid:false,sMsg:[]},s=[];if(!e.ServiceType){t.IsNotValid=true;t.sMsg.push("MSG_VALDTN_SERVTYPE");s.push({message:"MSG_VALDTN_SERVTYPE",target:"/oServiceData/ServiceType"})}else if(!e.ServiceMessage){t.IsNotValid=true;t.sMsg.push("MSG_VALDTN_SERVMSG");s.push({message:"MSG_VALDTN_SERVMSG",target:"/oServiceData/ServiceMessage"})}else if(e.ContactNumber){var a=/^[+][0-9]{5,15}$/;if(!a.test(e.ContactNumber)){t.IsNotValid=true;t.sMsg.push("MSG_INVALID_MOBILE");s.push({message:"MSG_INVALID_MOBILE",target:"/oServiceData/ContactNumber"})}}if(s.length){this._genCtrlMessages(s)}return t},onCancel:function(){this.getRouter().navTo("worklist",true)},onSave:function(e){this._oMessageManager.removeAllMessages();var t=this.getModel("objectView"),s=t.getProperty("/oDetails");var a=this._fnValidation(s);if(a.IsNotValid){this.showError(this._fnMsgConcatinator(a.sMsg));return}delete s.CreatedBy;delete s.UpdatedAt;delete s.UpdatedBy;delete s.CreatedAt;delete s.IncidentType;delete s.Navigation;delete s.Icon;delete s.__metadata;if(t.getProperty("/sMode")==="E"){var i=this;var r=i.getModel().createKey("/MasterServiceTypeSet",{Id:s.Id});i.getModel().update(r,s,{success:i._UploadImage(r,t.getProperty("/oImage")).then(i._Success.bind(i,e),i._Error.bind(i)),error:i._Error.bind(i)})}if(t.getProperty("/sMode")==="C"){var i=this;r="/MasterServiceTypeSet";this.getModel().create(r,s,{success:function(s){var a=r+"("+s.Id+")";i._UploadImage(a,t.getProperty("/oImage")).then(i._SuccessAdd.bind(i,e),i._Error.bind(i))},error:this._Error.bind(this)})}},_fnValidation:function(e){var t={IsNotValid:false,sMsg:[]},s=[];if(!e.ServiceType){t.IsNotValid=true;t.sMsg.push("MSG_VALDTN_SERVTYPE");s.push({message:"MSG_VALDTN_SERVTYPE",target:"/oDetails/ServiceType"})}else if(!e.ServiceMessage){t.IsNotValid=true;t.sMsg.push("MSG_VALDTN_SERVMSG");s.push({message:"MSG_VALDTN_SERVMSG",target:"/oDetails/ServiceMessage"})}else if(e.ContactNumber){var a=/^[+][0-9]{5,15}$/;if(!a.test(e.ContactNumber)){t.IsNotValid=true;t.sMsg.push("MSG_INVALID_MOBILE");s.push({message:"MSG_INVALID_MOBILE",target:"/oDetails/ContactNumber"})}}if(s.length){this._genCtrlMessages(s)}return t},_genCtrlMessages:function(e){var t=this,s=t.getModel("objectView");e.forEach(function(e){t._oMessageManager.addMessages(new sap.ui.core.message.Message({message:t.getResourceBundle().getText(e.message),type:sap.ui.core.MessageType.Error,target:e.target,processor:s,persistent:true}))})},_fnMsgConcatinator:function(e){var t=this;return e.map(function(e){return t.getResourceBundle().getText(e)}).join("")},_UploadImage:function(e,t){var s=this;return new Promise(function(a,i){if(!t){a();return}var r={url:"/EXPO_PODIUM_API/api/v2/odata.svc"+e+"/$value",data:t.Image,method:"PUT",headers:s.getModel().getHeaders(),contentType:"multipart/form-data",processData:false,success:function(){a.apply(s)},error:function(){i.apply(s)}};$.ajax(r)})},_Success:function(){this.getRouter().navTo("worklist",true);o.show(this.getResourceBundle().getText("MSG_SUCCESS"));var e=this.getModel();e.refresh(true)},_SuccessAdd:function(){this.getRouter().navTo("worklist",true);o.show(this.getResourceBundle().getText("MSG_SUCCESS_ADD"))},_SuccessChildEdit:function(e){o.show(this.getResourceBundle().getText("MSG_SUCCESS_SERVICE_CHILD_EDIT"));this.onClose(e)},_SuccessChildAdd:function(e){o.show(this.getResourceBundle().getText("MSG_SUCCESS_SERVICE_CHILD_ADD"));this.onClose(e)},_Error:function(e){o.show(e.toString())}})});