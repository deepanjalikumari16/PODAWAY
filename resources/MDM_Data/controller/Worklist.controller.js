jQuery.sap.require("com.coil.podway.MDM_Data.libs.mapsjs-core");jQuery.sap.require("com.coil.podway.MDM_Data.libs.mapsjs-service");jQuery.sap.require("com.coil.podway.MDM_Data.libs.mapsjs-ui");jQuery.sap.require("com.coil.podway.MDM_Data.libs.mapsjs-mapevents");sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/m/MessageToast"],function(e,t,i,a,s,r,o){"use strict";return e.extend("com.coil.podway.MDM_Data.controller.Worklist",{formatter:i,onInit:function(){var e,i,a=this.byId("table"),s=this.byId("table1"),r=this.byId("table2"),o=this.byId("table3"),n=this.byId("table4"),l=this.byId("table5"),d=this.byId("table6"),g=this.byId("table7"),u=this.byId("table8");i=a.getBusyIndicatorDelay();this._aTableSearchState=[];e=new t({worklistTableTitle:this.getResourceBundle().getText("worklistTableTitle"),saveAsTileTitle:this.getResourceBundle().getText("saveAsTileTitle",this.getResourceBundle().getText("worklistViewTitle")),shareOnJamTitle:this.getResourceBundle().getText("worklistTitle"),shareSendEmailSubject:this.getResourceBundle().getText("shareSendEmailWorklistSubject"),shareSendEmailMessage:this.getResourceBundle().getText("shareSendEmailWorklistMessage",[location.href]),tableNoDataText:this.getResourceBundle().getText("tableNoDataText"),tableBusyDelay:0});this.setModel(e,"worklistView");a.attachEventOnce("updateFinished",function(){e.setProperty("/tableBusyDelay",i)});s.attachEventOnce("updateFinished1",function(){e.setProperty("/tableBusyDelay",i)});r.attachEventOnce("updateFinished2",function(){e.setProperty("/tableBusyDelay",i)});o.attachEventOnce("updateFinished3",function(){e.setProperty("/tableBusyDelay",i)});n.attachEventOnce("updateFinished4",function(){e.setProperty("/tableBusyDelay",i)});l.attachEventOnce("updateFinished5",function(){e.setProperty("/tableBusyDelay",i)});d.attachEventOnce("updateFinished6",function(){e.setProperty("/tableBusyDelay",i)});g.attachEventOnce("updateFinished7",function(){e.setProperty("/tableBusyDelay",i)});u.attachEventOnce("updateFinished8",function(){e.setProperty("/tableBusyDelay",i)});this.addHistoryEntry({title:this.getResourceBundle().getText("worklistViewTitle"),icon:"sap-icon://table-view",intent:"#MasterDataManagement-display"},true)},onUpdateFinished:function(e){var t,i=this,a=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("IsArchived",sap.ui.model.FilterOperator.EQ,false),new sap.ui.model.Filter("IsChild",sap.ui.model.FilterOperator.EQ,false)],and:true});this.getModel().read("/MasterServiceTypeSet/$count",{filters:[a],async:true,success:function(e){t=i.getResourceBundle().getText("masterServiceCount",[e]);i.getModel("worklistView").setProperty("/masterService",t)}})},onUpdateFinished1:function(e){var t,i=this,a=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("IsArchived",sap.ui.model.FilterOperator.EQ,false)],and:true});this.getModel().read("/MasterFacilityTypeSet/$count",{filters:[a],async:true,success:function(e){t=i.getResourceBundle().getText("masterFacilityCount",[e]);i.getModel("worklistView").setProperty("/masterFacility",t)}})},onUpdateFinished2:function(e){var t,i=this,a=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("IsArchived",sap.ui.model.FilterOperator.EQ,false)],and:true});this.getModel().read("/MasterRelationshipSet/$count",{filters:[a],async:true,success:function(e){t=i.getResourceBundle().getText("masterRelationshipCount",[e]);i.getModel("worklistView").setProperty("/masterRelationship",t)}})},onUpdateFinished3:function(e){var t,i=this,a=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("IsArchived",sap.ui.model.FilterOperator.EQ,false)],and:true});this.getModel().read("/MasterFaqCategorySet/$count",{filters:[a],async:true,success:function(e){t=i.getResourceBundle().getText("masterFaqCategoryCount",[e]);i.getModel("worklistView").setProperty("/masterFaqCategory",t)}})},onUpdateFinished4:function(e){var t,i=this,a=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("IsArchived",sap.ui.model.FilterOperator.EQ,false)],and:true});this.getModel().read("/MasterEventAttractionTypeSet/$count",{filters:[a],async:true,success:function(e){t=i.getResourceBundle().getText("masterEventAttractionCount",[e]);i.getModel("worklistView").setProperty("/masterEventAttraction",t)}})},onUpdateFinished5:function(e){var t,i=this,a=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("IsArchived",sap.ui.model.FilterOperator.EQ,false)],and:true});this.getModel().read("/MasterNavigationTypeSet/$count",{filters:[a],async:true,success:function(e){t=i.getResourceBundle().getText("masterNavigationCount",[e]);i.getModel("worklistView").setProperty("/masterNavigation",t)}})},onUpdateFinished6:function(e){var t,i=this,a=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("IsArchived",sap.ui.model.FilterOperator.EQ,false)],and:true});this.getModel().read("/BuildingSet/$count",{filters:[a],async:true,success:function(e){t=i.getResourceBundle().getText("buildingCount",[e]);i.getModel("worklistView").setProperty("/building",t)}})},onUpdateFinished7:function(e){var t,i=this,a=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("IsArchived",sap.ui.model.FilterOperator.EQ,false)],and:true});this.getModel().read("/ThemeSet/$count",{filters:[a],async:true,success:function(e){t=i.getResourceBundle().getText("themeCount",[e]);i.getModel("worklistView").setProperty("/theme",t)}})},onUpdateFinished8:function(e){var t,i=this,a=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("IsArchived",sap.ui.model.FilterOperator.EQ,false)],and:true});this.getModel().read("/CategorySet/$count",{filters:[a],async:true,success:function(e){t=i.getResourceBundle().getText("categoryCount",[e]);i.getModel("worklistView").setProperty("/category",t)}})},onUpdateFinished9:function(e){var t,i=this,a=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("IsArchived",sap.ui.model.FilterOperator.EQ,false)],and:true});this.getModel().read("/MasterSpecialitySet/$count",{filters:[a],async:true,success:function(e){t=i.getResourceBundle().getText("specialityCount",[e]);i.getModel("worklistView").setProperty("/speciality",t)}})},onPress:function(e){this._showObject(e.getSource())},onChangeNavType:function(e){this.getModel("worklistView").setProperty("/oEditData/NavigationTypeName",e.getParameter("newValue"))},onMobileValidate:function(){},onViewImage:function(e,t){var i=this.getView(),a=this;a.oImageBindingContext=e.getSource().getBindingContext();if(!a._oDlgAddOption){r.load({id:i.getId(),name:"com.coil.podway.MDM_Data.dialog.Images",controller:a}).then(function(e){a._oDlgAddOption=e;i.addDependent(e);e.open()})}else{a._oDlgAddOption.open()}this.getModel("worklistView").setProperty("/sDialog",t)},bindDialog:function(){var e=this,t=this.getModel("worklistView");this._oDlgAddOption.getContent()[0].bindAggregation("pages",{path:"/MasterEventAttractionTypeSet",filters:[new a("IsArchived",s.EQ,false),new a("Id",s.EQ,e.oImageBindingContext.getProperty("Id"))],template:new sap.m.Image({src:{path:"__metadata",formatter:e.formatter.giveImage}}),events:{dataRequested:function(){t.setProperty("/bLoadingImages",true)},dataReceived:function(e){t.setProperty("/bLoadingImages",false);if(e.getParameter("data").results.length){t.setProperty("/bImages",true)}else{t.setProperty("/bImages",false)}}}})},onCancelImage:function(){this._oDlgAddOption.close()},onMap:function(){var e=this;r.load({id:e.getView().getId(),type:"HTML",name:"com.coil.podway.MDM_Data.dialog.HEREMaps",controller:e}).then(function(t){var i=new H.service.Platform({apikey:"BbN_bDCaLx6-5GZou8CHRvPWpf9CoDtVbMK4w-OTAxM"});var a=i.createDefaultLayers();this.getView().byId("map");var s=new H.Map(document.getElementById("map"),a.vector.normal.map,{zoom:15,center:{lng:55.14711,lat:24.962762}});var r=new H.mapevents.Behavior(new H.mapevents.MapEvents(s));var o=H.ui.UI.createDefault(s,a);e.getView().addDependent(t);e.addDraggableMarker(s,r);t.open()}.bind(this))},onCloseMaps:function(){this.getView().byId("MapDialog").close();this.getView().byId("MapDialog").destroy()},addDraggableMarker:function(e,t){var i=this.getModel("worklistView");var a=new H.map.Marker({lng:55.14711,lat:24.962762},{volatility:true});a.draggable=true;e.addObject(a);e.addEventListener("dragstart",function(i){var a=i.target,s=i.currentPointer;if(a instanceof H.map.Marker){var r=e.geoToScreen(a.getGeometry());a["offset"]=new H.math.Point(s.viewportX-r.x,s.viewportY-r.y);t.disable()}},false);e.addEventListener("dragend",function(e){var a=e.target;if(a instanceof H.map.Marker){t.enable();i.setProperty("/oEditData/Longitude",a.getGeometry().lng.toString());i.setProperty("/oEditData/Latitude",a.getGeometry().lat.toString())}},false);e.addEventListener("drag",function(t){var i=t.target,a=t.currentPointer;if(i instanceof H.map.Marker){i.setGeometry(e.screenToGeo(a.viewportX-i["offset"].x,a.viewportY-i["offset"].y))}},false)},onEdit:function(e){var t=this.getView().byId("idIconTabBar3").getSelectedKey(),i=this.getModel("worklistView");var a=this.getResourceBundle().getText("colEdit");i.setProperty("/opMode",a);i.setProperty("/operation","E");var s={Service:false,Facility:false,Relationship:false,FAQ:false,Event:false,Navigation:false,Building:false,Theme:false,Category:false,Speciality:false};if(t==="Service"){this._showObject(e.getSource())}else{s[t]=true;i.setProperty("/bEditOptions",s);var o=e.getSource().getBindingContext().getObject();i.setProperty("/oEditData",o);i.setProperty("/sEditPath",e.getSource().getBindingContext().getPath());if(t==="Event"){var n="Event Attraction";i.setProperty("/sDialogTitle",n)}else{i.setProperty("/sDialogTitle",t)}var l=this.getView();if(!this.byId("detailsDialog")){r.load({id:l.getId(),name:"com.coil.podway.MDM_Data.dialog.details",controller:this}).then(function(e){l.addDependent(e);e.open()})}else{this.byId("detailsDialog").open()}}},onAdd:function(e){var t=this.getView().byId("idIconTabBar3").getSelectedKey(),i=this.getModel("worklistView");var a=this.getResourceBundle().getText("colAdd");i.setProperty("/opMode",a);i.setProperty("/operation","C");var s={Service:false,Facility:false,Relationship:false,FAQ:false,Event:false,Navigation:false,Building:false,Theme:false,Category:false,Speciality:false};if(t==="Service"){this.getRouter().navTo("createObject")}else{s[t]=true;i.setProperty("/bEditOptions",s);i.setProperty("/oEditData",{EventAttractionType:"",Description:"",IsBuilding:false,IsCategory:false,IsTheme:false,FacilityType:"",NavigationGroupId:0,NavigationTypeName:"",FaqCategory:"",BuildingName:"",Theme:"",Category:"",Speciality:"",Relationship:"",IsArchived:false});if(t==="Event"){i.setProperty("/sEditPath","/MasterEventAttractionTypeSet");i.setProperty("/oEditData",{EventAttractionType:"",Description:"",IsBuilding:false,IsCategory:false,IsTheme:false,IsArchived:false})}else if(t==="Facility"){i.setProperty("/sEditPath","/MasterFacilityTypeSet");i.setProperty("/oEditData",{FacilityType:"",IsArchived:false})}else if(t==="Navigation"){i.setProperty("/sEditPath","/MasterNavigationTypeSet");i.setProperty("/oEditData",{NavigationGroupId:0,NavigationTypeName:"",IsArchived:false})}else if(t==="FAQ"){i.setProperty("/sEditPath","/MasterFaqCategorySet");i.setProperty("/oEditData",{FaqCategory:"",IsArchived:false})}else if(t==="Building"){i.setProperty("/sEditPath","/BuildingSet");i.setProperty("/oEditData",{BuildingName:"",IsArchived:false})}else if(t==="Theme"){i.setProperty("/sEditPath","/ThemeSet");i.setProperty("/oEditData",{Theme:"",IsArchived:false})}else if(t==="Category"){i.setProperty("/sEditPath","/CategorySet");i.setProperty("/oEditData",{Category:"",IsArchived:false})}else if(t==="Speciality"){i.setProperty("/sEditPath","/MasterSpecialitySet");i.setProperty("/oEditData",{Speciality:"",IsArchived:false})}else if(t==="Relationship"){i.setProperty("/sEditPath","/MasterRelationshipSet");i.setProperty("/oEditData",{Relationship:"",IsArchived:false})}if(t==="Event"){var o="Event Attraction";i.setProperty("/sDialogTitle",o)}else{i.setProperty("/sDialogTitle",t)}var n=this.getView();if(!this.byId("detailsDialog")){r.load({id:n.getId(),name:"com.coil.podway.MDM_Data.dialog.details",controller:this}).then(function(e){n.addDependent(e);e.open()})}else{this.byId("detailsDialog").open()}}},onDelete:function(e){var t=e.getSource().getBindingContext().getPath();var i=this.getModel().getData(t);var a=this._fnValidationCantDelete(i);if(a.IsNotValid){this.showError(this._fnMsgConcatinator(a.sMsg));return}function s(){var e=this.getModel().getData(t);this.getModel().update(t,{IsArchived:true},{success:this.showToast.bind(this,"MSG_SUCCESS_REMOVE")})}this.showWarning("MSG_CONFIRM_MDM_DELETE",s)},_fnValidationCantDelete:function(e){var t={IsNotValid:false,sMsg:[]};if(e.CreatedBy===null){t.IsNotValid=true;t.sMsg.push("MSG_CANNOT_DELETE_SYSTEM_DATA")}return t},onRefreshView:function(){var e=this.getModel();e.refresh(true)},onClose:function(e){this.byId("detailsDialog").close();this.getModel().refresh(true);this.getModel("worklistView").setProperty("/oImage",null)},onUpload:function(e){var t=e.getSource().FUEl.files[0];this.getImageBinary(t).then(this._fnAddFile.bind(this))},onAfterRendering:function(){this._initMessage()},_initMessage:function(){var e=this.getModel("worklistView");this._oMessageManager=sap.ui.getCore().getMessageManager();this._oMessageManager.registerMessageProcessor(e)},onSave:function(e){this._oMessageManager.removeAllMessages();var t=this.getModel("worklistView"),i=t.getProperty("/oEditData"),a=t.getProperty("/sEditPath");var s=this._fnValidation(i);if(s.IsNotValid){this.showError(this._fnMsgConcatinator(s.sMsg));return}delete i.CreatedBy;delete i.UpdatedAt;delete i.UpdatedBy;delete i.CreatedAt;delete i.IncidentType;delete i.Navigation;delete i.Icon;delete i.__metadata;delete i.Id;var r=t.getProperty("/operation");if(r==="E"){this.getModel().update(a,i,{success:function(){this._UploadImage(a,t.getProperty("/oImage")).then(this._Success.bind(this,e),this._Error.bind(this))}.bind(this),error:this._Error.bind(this)})}else if(r==="C"){var o=this;this.getModel().create(a,i,{success:function(i){var s=a+"("+i.Id+")";o._UploadImage(s,t.getProperty("/oImage")).then(o._SuccessAdd.bind(o,e),o._Error.bind(o))},error:this._Error.bind(this)})}},_fnValidation:function(e){var t={IsNotValid:false,sMsg:[]},i=[];var a=this.getModel("worklistView");if(a.getProperty("/bEditOptions").Facility===true){if(!e.FacilityType){t.IsNotValid=true;t.sMsg.push("MSG_VALDTN_FTYPE");i.push({message:"MSG_VALDTN_FTYPE",target:"/oEditData/FacilityType"})}}if(a.getProperty("/bEditOptions").Relationship===true){if(!e.Relationship){t.IsNotValid=true;t.sMsg.push("MSG_VALDTN_RELATION");i.push({message:"MSG_VALDTN_RELATION",target:"/oEditData/Relationship"})}}if(a.getProperty("/bEditOptions").FAQ===true){if(!e.FaqCategory){t.IsNotValid=true;t.sMsg.push("MSG_VALDTN_FAQCAT");i.push({message:"MSG_VALDTN_FAQCAT",target:"/oEditData/FaqCategory"})}}if(a.getProperty("/bEditOptions").Event===true){if(!e.EventAttractionType){t.IsNotValid=true;t.sMsg.push("MSG_VALDTN_EAT");i.push({message:"MSG_VALDTN_EAT",target:"/oEditData/EventAttractionType"})}}if(a.getProperty("/bEditOptions").Navigation===true){if(!e.NavigationTypeName){t.IsNotValid=true;t.sMsg.push("MSG_VALDTN_NTN");i.push({message:"MSG_VALDTN_NTN",target:"/oEditData/NavigationTypeName"})}}if(a.getProperty("/bEditOptions").Building===true){if(!e.BuildingName){t.IsNotValid=true;t.sMsg.push("MSG_VALDTN_BUILDING");i.push({message:"MSG_VALDTN_BUILDING",target:"/oEditData/BuildingName"})}if(+e.Longitude==0||+e.Latitude==0){t.IsNotValid=true;t.sMsg.push("MSG_LAT_LNG");i.push({message:"MSG_LAT_LNG",target:"/oEditData/Latitude"});i.push({message:"MSG_LAT_LNG",target:"/oEditData/Longitude"})}else if(+e.Latitude<-90||+e.Latitude>90){t.IsNotValid=true;t.sMsg.push("MSG_ERR_LAT");i.push({message:"MSG_ERR_LAT",target:"/oEditData/Latitude"})}else if(+e.Longitude<-180||+e.Longitude>180){t.IsNotValid=true;t.sMsg.push("MSG_ERR_LNG");i.push({message:"MSG_ERR_LNG",target:"/oEditData/Longitude"})}}if(a.getProperty("/bEditOptions").Theme===true){if(!e.Theme){t.IsNotValid=true;t.sMsg.push("MSG_VALDTN_THEME");i.push({message:"MSG_VALDTN_THEME",target:"/oEditData/Theme"})}}if(a.getProperty("/bEditOptions").Category===true){if(!e.Category){t.IsNotValid=true;t.sMsg.push("MSG_VALDTN_CATEGORY");i.push({message:"MSG_VALDTN_CATEGORY",target:"/oEditData/Category"})}}if(a.getProperty("/bEditOptions").Speciality===true){if(!e.Speciality){t.IsNotValid=true;t.sMsg.push("MSG_VALDTN_SPECIALITY");i.push({message:"MSG_VALDTN_SPECIALITY",target:"/oEditData/Speciality"})}}if(i.length)this._genCtrlMessages(i);return t},_genCtrlMessages:function(e){var t=this,i=t.getModel("worklistView");e.forEach(function(e){t._oMessageManager.addMessages(new sap.ui.core.message.Message({message:t.getResourceBundle().getText(e.message),type:sap.ui.core.MessageType.Error,target:e.target,processor:i,persistent:true}))})},_fnMsgConcatinator:function(e){var t=this;return e.map(function(e){return t.getResourceBundle().getText(e)}).join("")},_UploadImage:function(e,t){var i=this;return new Promise(function(a,s){if(!t){a();return}var r={url:"/EXPO_PODIUM_API/api/v2/odata.svc"+e+"/$value",data:t.Image,method:"PUT",headers:i.getModel().getHeaders(),contentType:"multipart/form-data",processData:false,success:function(){a.apply(i)},error:function(){s.apply(i)}};$.ajax(r)})},onShareInJamPress:function(){var e=this.getModel("worklistView"),t=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:location.href,share:e.getProperty("/shareOnJamTitle")}}});t.open()},onSearch:function(){var e=this.getFiltersfromFB(),t=this.getView().byId("table"),i=this.getView().byId("table1"),a=this.getView().byId("table2"),s=this.getView().byId("table3"),r=this.getView().byId("table4"),o=this.getView().byId("table5");t.getBinding("items").filter(e);i.getBinding("items").filter(e);a.getBinding("items").filter(e);s.getBinding("items").filter(e);r.getBinding("items").filter(e);o.getBinding("items").filter(e);if(e.length!==0){this.getModel("worklistView").setProperty("/tableNoDataText",this.getResourceBundle().getText("worklistNoDataWithSearchText"))}},onRefresh:function(){var e=this.byId("table"),t=this.byId("table1"),i=this.byId("table2"),a=this.byId("table3"),s=this.byId("table4"),r=this.byId("table5");e.getBinding("items").refresh();t.getBinding("items").refresh();i.getBinding("items").refresh();a.getBinding("items").refresh();s.getBinding("items").refresh();r.getBinding("items").refresh()},_showObject:function(e){this.getRouter().navTo("object",{objectId:e.getBindingContext().getProperty("Id")})},_Success:function(e){o.show(this.getResourceBundle().getText("MSG_SUCCESS"));this.onClose(e)},_SuccessAdd:function(e){o.show(this.getResourceBundle().getText("MSG_SUCCESS_ADD"));this.onClose(e)},_Error:function(e){o.show(e.toString())},_applySearch:function(e){var t=this.byId("table"),i=this.byId("table1"),a=this.byId("table2"),s=this.byId("table3"),r=this.byId("table4"),o=this.byId("table5"),n=this.getModel("worklistView");t.getBinding("items").filter(e,"Application");i.getBinding("items").filter(e,"Application");a.getBinding("items").filter(e,"Application");s.getBinding("items").filter(e,"Application");r.getBinding("items").filter(e,"Application");o.getBinding("items").filter(e,"Application");if(e.length!==0){n.setProperty("/tableNoDataText",this.getResourceBundle().getText("worklistNoDataWithSearchText"))}},getImageBinary:function(e){var t=new FileReader;var i=e.name;return new Promise(function(a,s){if(!(e instanceof File)){a(e);return}t.onloadend=function(e){a({Image:new Blob([this.result],{type:"image/jpeg"}),name:i})};t.readAsArrayBuffer(e)})},_fnAddFile:function(e){this.getModel("worklistView").setProperty("/oImage",{Image:e.Image,FileName:e.name,IsArchived:false});this.getModel("worklistView").refresh()}})});