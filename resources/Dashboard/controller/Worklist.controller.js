sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/viz/ui5/format/ChartFormatter","sap/viz/ui5/api/env/Format","sap/ui/core/Fragment"],function(t,e,a,i,o,s,r,n){"use strict";return t.extend("com.coil.podway.Dashboard.controller.Worklist",{formatter:a,onInit:function(){try{jQuery.sap.require("com.coil.podway.Dashboard.libs.mapsjs-core");jQuery.sap.require("com.coil.podway.Dashboard.libs.mapsjs-service");jQuery.sap.require("com.coil.podway.Dashboard.libs.mapsjs-ui");jQuery.sap.require("com.coil.podway.Dashboard.libs.mapsjs-mapevents");jQuery.sap.require("com.coil.podway.Dashboard.libs.mapsjs-data");jQuery.sap.require("com.coil.podway.Dashboard.libs.mapsjs-clustering")}catch(t){console.log(t)}this.setLocalModel();this.addHistoryEntry({title:this.getResourceBundle().getText("worklistViewTitle"),icon:"sap-icon://table-view",intent:"#Dashboard-Display"},true);this._enableDesktopNotification()},onUpdateNotifications:function(t){var e=this.getView().getModel("dashboard");if(t.getParameter("reason")==="Growing"){this.iNotificationTop+=10;this.iNotificationSkip+=10;this.loadNotifications()}},onAfterRendering:function(){this.getModel().metadataLoaded().then(this._getUsers.bind(this))},refresh:function(t){var e;if(t){clearInterval(refersh);return}e=setInterval(this._getUsers.bind(this),3e4)},onObject:function(){this.getRouter().navTo("object")},handleNotificationPopoverPress:function(t){var e=this.getView();var a=t.getSource();this.iNotificationTop=10;this.iNotificationSkip=0;this._MarkAsRead();if(!this._oPopover){n.load({name:"com.coil.podway.Dashboard.dialog.Notifications",controller:this}).then(function(t){e.addDependent(t);this._oPopover=t;this._oPopover.openBy(a)}.bind(this))}else{this._oPopover.openBy(a)}},onItemClose:function(t){var e=t.getSource(),a=e.getParent();a.removeItem(e)},loadNotifications:function(){var t=this;var e=this.getView().getModel("dashboard");e.setProperty("/bNotificationBusy",true);t.getModel().read("/GetNotifications",{urlParameters:{$expand:"Notification,Notification/Redirection",$orderby:"TriggeredAt desc",Top:this.iNotificationTop,Skip:this.iNotificationSkip},success:function(t){e.setProperty("/bNotificationBusy",false);var a=e.getProperty("/aNotifications");if(a.length>0){e.setProperty("/aNotifications",a.concat(t.results))}else{e.setProperty("/aNotifications",t.results)}}})},_MarkAsRead:function(){var t=this.getView().getModel("dashboard");var e=this.getModel();if(+t.getProperty("/iNotificationCount")>0){e.callFunction("/MarkAsReadNotification",{success:function(){t.setProperty("/iNotificationCount","")}})}},setLocalModel:function(){var t=new e({bMapBusy:true,aNotifications:[],bViewBusy:false,logo:sap.ui.require.toUrl("com/coil/podway/Dashboard/css/wheelchair.svg"),EmergencyLogo:sap.ui.require.toUrl("com/coil/podway/Dashboard/css/wheelchair_1.svg"),AlertLogo:sap.ui.require.toUrl("com/coil/podway/Dashboard/css/triangle.svg"),bHeapMap:false});this.setModel(t,"dashboard")},toAssignments:function(t){var e={target:{semanticObject:"Manage",action:"Assignment"}};if(t){e.params={isEmergency:true}}this.Navigate(e)},toPODVisitors:function(){this.Navigate({target:{semanticObject:"Manage",action:"Visitor"}})},Navigate:function(t){var e=sap.ushell.Container.getService("CrossApplicationNavigation");e.isNavigationSupported([{target:{shellHash:t.target.semanticObject.concat("-",t.target.action)}}]).done(function(a){if(!a[0].supported)return;e.toExternal(t)})},changeMap:function(){this.getModel("dashboard").setProperty("/bHeapMap",!this.getModel("dashboard").getProperty("/bHeapMap"))},_getUsers:function(){var t=[],e=this;if(!this.binitLoadDone){this.getModel("dashboard").setProperty("/bViewBusy",true);this.binitLoadDone=true}t.push(new Promise(function(t,a){e.getModel().read("/UserSet",{filters:[new i("IsArchived",o.EQ,false),new i("RoleId",o.EQ,3)],urlParameters:{$expand:"UserPreference/UserAccessibilityList/AccessiblityItem,UserDevice"},success:function(e){t(e)},error:function(t){a(t)}})}));t.push(new Promise(function(t,a){e.getModel().read("/AssignmentSet",{filters:e._getFiltersForAssigment(),urlParameters:{$expand:"ServiceType/IncidentType,PODVisitor"},success:function(e){t(e)},error:function(t){a(t)}})}));t.push(new Promise(function(t,a){e.getModel().read("/GetDashboardKPI",{urlParameters:{$expand:"TotalVisitorsByCategory,TotalOnsiteVisitorsByCategory,TotalAssignmentsByIncidentType,TotalAssignmentsByStatus"},success:function(e){t(e)},error:function(t){a(t)}})}));t.push(new Promise(function(t,a){e.getModel().read("/GetNotificationCount",{success:function(e){t(e)},error:function(t){a(t)}})}));Promise.all(t).then(e._setView.bind(e))},_setView:function(t){var e=this.getModel("dashboard");e.setProperty("/bViewBusy",false);var a=this,i=t[0].results,o=t[1].results.map(function(t){return t.PODVisitor});a._setMap(i,o);a._setCharts(t[2].results[0]);var s=+e.getProperty("/iNotificationCount");if(s&&s!==t[3].Count){sap.m.MessageToast.show(this.getResourceBundle().getText("MSG_NEW_NOTO",[t[3].Count]))}this.getModel("dashboard").setProperty("/iNotificationCount",t[3].Count)},_setCharts:function(t){var e=this.getModel("dashboard");e.setProperty("/iTotalPOD",t.TotalVisitors);e.setProperty("/iTotalPODActive",t.TotalOnsiteVisitors);e.setProperty("/EmergecnyIncidents",t.TotalAssignmentsByIncidentType.results[0].Total);var a=0;t.TotalAssignmentsByIncidentType.results.forEach(function(t){a+=t.Total});e.setProperty("/TotalIncidents",a);e.setProperty("/TotalAssignments",t.TotalAssignments);e.setProperty("/PODByCategory",t.TotalVisitorsByCategory.results);e.setProperty("/PODByOnsiteCategory",t.TotalOnsiteVisitorsByCategory.results);e.setProperty("/AssignmentStatues",{pending:t.TotalAssignmentsByStatus.results[0].Total,inprogress:t.TotalAssignmentsByStatus.results[1].Total,completed:t.TotalAssignmentsByStatus.results[2].Total,cancelled:t.TotalAssignmentsByStatus.results[3].Total})},onOpenPODCategoriesDialog:function(){var t=this.getView(),e=this;if(!e._oDlgChartOption){n.load({id:t.getId(),name:"com.coil.podway.Dashboard.dialog.CategoryChart",controller:e}).then(function(a){e._oDlgChartOption=a;r.numericFormatter(s.getInstance());var i=s.DefaultPattern;var o=a.getContent()[0].getItems()[0];o.setVizProperties({plotArea:{dataLabel:{formatString:i.SHORTFLOAT_MFD2,visible:true}},valueAxis:{label:{formatString:i.SHORTFLOAT},title:{visible:true}},categoryAxis:{title:{visible:true}},title:{visible:false}});t.addDependent(a);a.open()})}else{e._oDlgChartOption.open()}},onCloseCategoryDlg:function(){this._oDlgChartOption.close()},_setMap:function(t,e){var a=this.getModel("dashboard");var i=new Set,o=this;e.forEach(function(t){i.add(t)});this._setHeatMap(t,e,i);var s=this._initMap("map");var r=new H.map.Group;s[0].addObject(r);r.addEventListener("tap",function(t){var e=new H.ui.InfoBubble(t.target.getGeometry(),{content:t.target.getData()});s[1].addBubble(e)},false);var n,l=sap.ushell.Container.getService("CrossApplicationNavigation");var c=[];e.forEach(function(t){if(!!t){n=o.getHTMLPart(l,t);c.push(new H.clustering.DataPoint(t.Latitude,t.Longitude));o.addDraggableMarker(r,n,t.Latitude,t.Longitude,true)}});t.forEach(function(t){if(!i.has(t)){c.push(new H.clustering.DataPoint(t.Latitude,t.Longitude));n=o.getHTMLPart(l,t);o.addDraggableMarker(r,n,t.Latitude,t.Longitude,false)}});var d=new H.clustering.Provider(c);var u=new H.map.layer.ObjectLayer(d);s[0].addLayer(u);a.setProperty("/bMapBusy",false)},bindMapProperties:function(){var t=this.getView();t.byId("map").bindProperty("visible",{path:"/bHeapMap",model:"dashboard",formatter:function(t){return!t}});t.byId("heatMap").bindProperty("visible",{path:"/bHeapMap",model:"dashboard"})},_setHeatMap:function(t,e,a){var i=this._initMap("heatMap");var o=new H.data.heatmap.Provider({colors:new H.data.heatmap.Colors({0:"blue",.5:"yellow",1:"red"},true),opacity:.6,assumeValues:false});var s=[];t.forEach(function(t){if(!a.has(t)){if(+t.Latitude&&+t.Longitude){s.push({lat:+t.Latitude,lng:+t.Longitude,value:.5})}}});e.forEach(function(t){if(!!t&&+t.Latitude&&+t.Longitude){s.push({lat:+t.Latitude,lng:+t.Longitude,value:1})}});o.addData(s);i[0].addLayer(new H.map.layer.TileLayer(o))},getHTMLPart:function(t,e){var a="";if(t){window.toExtFrmdashBoard=function(e){t.toExternal({target:{shellHash:"Manage-Visitor&/UserSet/"+e}})};a="href='#'  onclick='toExtFrmdashBoard( "+e.Id+")'"}return"<div style='white-space: nowrap;'  > "+e.FirstName+" "+e.LastName+"<br><a target='_self' "+a+">More details</a> </div>"},_initMap:function(t){var e=new H.service.Platform({apikey:"BbN_bDCaLx6-5GZou8CHRvPWpf9CoDtVbMK4w-OTAxM"});if(t==="map"&&this.map){return[this.map,this.mapUi]}if(t==="heatMap"&&this.heatMap){return[this.heatMap,this.heatMapUi]}var a=e.createDefaultLayers();var i=new H.Map(this.getView().byId(t).getDomRef(),a.vector.normal.map,{zoom:15,center:{lng:55.14711,lat:24.962762}});var o=new H.mapevents.Behavior(new H.mapevents.MapEvents(i));var s=H.ui.UI.createDefault(i,a);switch(t){case"map":this.map=i;this.mapUi=s;break;case"heatMap":this.heatMap=i;this.heatMapUi=s}return[i,s]},addDraggableMarker:function(t,e,a,i,o){var s={volatility:false};if(+a&&+i){var r={lng:+i,lat:+a};var n;if(o){n='<svg xmlns="http://www.w3.org/2000/svg" fill="red"  width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-4.198 0-8 3.403-8 7.602 0 4.198 3.469 9.21 8 16.398 4.531-7.188 8-12.2 8-16.398 0-4.199-3.801-7.602-8-7.602zm0 11c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3z"/></svg>'}else{n='<svg xmlns="http://www.w3.org/2000/svg" fill="green"  width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-4.198 0-8 3.403-8 7.602 0 4.198 3.469 9.21 8 16.398 4.531-7.188 8-12.2 8-16.398 0-4.199-3.801-7.602-8-7.602zm0 11c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3z"/></svg>'}s.icon=new H.map.Icon(n);var l=new H.map.Marker(r,s);l.draggable=false;l.setData(e);t.addObject(l)}},_getFiltersForAssigment:function(){var t=new i({filters:[new i("AssignmentStatusId",o.EQ,1),new i("AssignmentStatusId",o.EQ,2)],bAnd:false,and:false});return[t,new i("IsArchived",o.EQ,false),new i("ServiceType/IncidentType/IncidentType",o.EQ,"Emergency")]},_enableDesktopNotification:function(){if(Notification.permission==="default"){Notification.requestPermission()}}})});