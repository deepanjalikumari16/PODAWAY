sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/m/MessageToast","sap/m/MessageBox"],function(e,t,i,o,s,r,n,a){"use strict";return e.extend("com.coil.podway.VisitorJourney.controller.Worklist",{formatter:i,onInit:function(){var e,i,o=this.getView().byId("table");i=o.getBusyIndicatorDelay();this._aTableSearchState=[];e=new t({worklistTableTitle:this.getResourceBundle().getText("worklistTableTitle"),worklistListTitle:this.getResourceBundle().getText("worklistListTitle"),saveAsTileTitle:this.getResourceBundle().getText("saveAsTileTitle",this.getResourceBundle().getText("worklistViewTitle")),shareOnJamTitle:this.getResourceBundle().getText("worklistTitle"),shareSendEmailSubject:this.getResourceBundle().getText("shareSendEmailWorklistSubject"),shareSendEmailMessage:this.getResourceBundle().getText("shareSendEmailWorklistMessage",[location.href]),tableNoDataText:this.getResourceBundle().getText("tableNoDataText"),tableBusyDelay:0,aRestEvents:[],aJourneys:[],bSave:false});this.setModel(e,"worklistView");o.attachEventOnce("updateFinished",function(){e.setProperty("/tableBusyDelay",i)});this.addHistoryEntry({title:this.getResourceBundle().getText("worklistViewTitle"),intent:"#Manage-Journey"},true)},onAfterRendering:function(){if(!this.getModel("device").getProperty("/system/desktop")){var e=!!this.getView().$().closest(".sapUiSizeCompact").length;sap.m.MessageBox.error(this.getResourceBundle().getText("ERR_DEVICE"),{styleClass:e?"sapUiSizeCompact":"",onClose:function(){this.getView().setBlocked(true)}.bind(this)});return}this.getModel().metadataLoaded().then(this._loadConfigData.bind(this))},_loadConfigData:function(){var e=this,t=[];if(!this.getModel("worklistView").getProperty("/appConfig"))t.push(new Promise(function(t,i){e.getModel().read("/MasterApplicationConfigSet(1)",{success:function(e){t(e)},error:function(e){i(e)}})}));t.push(new Promise(function(t,i){e.getModel().read("/EventAttractionSet",{filters:[new o("EventAttractionTypeId",s.EQ,1),new o("IsArchived",s.EQ,false)],sorters:[new sap.ui.model.Sorter("Index"),new sap.ui.model.Sorter("Name")],urlParameters:{$expand:"Building"},success:function(e){t(e)},error:function(e){i(e)}})}));Promise.all(t).then(e._configLoaded.bind(e))},_configLoaded:function(e){if(this.getModel("worklistView").getProperty("/appConfig")){this._setData(e[0]);return}this.getModel("worklistView").setProperty("/appConfig",e[0]);this._setData(e[1])},_setData:function(e){var t=this.getModel("worklistView");var i=t.getProperty("/appConfig/Value");var o=[],s=[];e.results.forEach(function(e){if(e.Index&&e.Index<=i){o.push(e)}else{s.push(e)}});t.setProperty("/aJourneys",o);t.setProperty("/aRestEvents",s)},onViewImage:function(e,t){var i=this.getView(),o=this;o.oImageBindingContext=e.getSource().getBindingContext("worklistView");if(!o._oDlgAddOption){r.load({id:i.getId(),name:"com.coil.podway.VisitorJourney.dialog.Images",controller:o}).then(function(e){o._oDlgAddOption=e;i.addDependent(e);e.open()})}else{o._oDlgAddOption.open()}this.getModel("worklistView").setProperty("/sDialog",t)},bindDialog:function(){var e=this,t=this.getModel("worklistView"),i=t.getProperty("/sDialog");this._oDlgAddOption.getContent()[0].bindAggregation("pages",{path:i==="I"?"/EventAttractionImageSet":"/EventAttractionPlanSet",filters:[new o("IsArchived",s.EQ,false),new o("EventAttractionId",s.EQ,e.oImageBindingContext.getProperty("Id"))],template:new sap.m.Image({src:{path:"__metadata",formatter:e.formatter.giveImage}}),events:{dataRequested:function(){t.setProperty("/bLoadingImages",true)},dataReceived:function(e){t.setProperty("/bLoadingImages",false);if(e.getParameter("data").results.length){t.setProperty("/bImages",true)}else{t.setProperty("/bImages",false)}}}})},onCancelImage:function(){this._oDlgAddOption.close()},onSelectionChange:function(){var e=this._getListObject(),t=this.getModel("worklistView");if(e.getProperty("Index")===1){t.setProperty("/bTopDisabled",false)}else{t.setProperty("/bTopDisabled",true)}if(e.getProperty("Index")===+t.getProperty("/aJourneys/length")){t.setProperty("/bBottomDisabled",false)}else{t.setProperty("/bBottomDisabled",true)}},onMoveJourney:function(e){var t=this._getListObject();if(!t){n.show(this.getResourceBundle().getText("MSG_SELECTITEM_FIRST"));return}var i=this.getModel("worklistView"),o=i.getProperty("/aJourneys");i.setProperty("/bSave",true);var s=e.getSource().getIcon(),r=+t.getProperty("Index"),a=s.includes("top")?r-1:r+1;o=o.map(function(e){switch(e.Index){case r:e.Index=a;break;case a:e.Index=r;break}return e});i.setProperty("/aJourneys",o);this.onSelectionChange();i.refresh(true)},onRemoveEvent:function(){var e=this._getListObject();if(!e){n.show(this.getResourceBundle().getText("MSG_SELECTITEM_FIRST"));return}var t=this.getModel("worklistView"),i=t.getProperty("/aJourneys"),o=e.getObject(),s=[],r=1;t.setProperty("/bSave",true);i.forEach(function(e){if(e.Index!==o.Index){e.Index=r;s.push(e);++r}});var a=t.getProperty("/aRestEvents");o.Index=null;a.push(o);t.setProperty("/aJourneys",s);t.setProperty("/aRestEvents",a);t.refresh(true)},onAddToJourney:function(e){var t=this.getModel("worklistView"),i=t.getProperty("/aJourneys"),o=t.getProperty("/aRestEvents"),s=e.getSource().getBindingContext("worklistView").getObject();t.setProperty("/bSave",true);if(i.length>=t.getProperty("/appConfig/Value")){n.show(this.getResourceBundle().getText("MSG_JLIMIT",[t.getProperty("/appConfig/Value")]));return}o=o.filter(function(e){return e.Id!==s.Id});s.Index=i.length+1;i.push(s);t.setProperty("/aJourneys",i);t.setProperty("/aRestEvents",o);t.refresh(true)},onUpdateFinished:function(e){var t,i=e.getSource(),o=e.getParameter("total");var s=i instanceof sap.m.Table?"Table":"List";if(o&&i.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("worklist"+s+"TitleCount",[o])}else{t=this.getResourceBundle().getText("worklist"+s+"Title")}this.getModel("worklistView").setProperty("/worklist"+s+"Title",t)},onShowConfirmation:function(){var e=!!this.getView().$().closest(".sapUiSizeCompact").length;a.warning(this.getResourceBundle().getText("MSG_SUCCESS_CONFRM"),{actions:[a.Action.NO,a.Action.YES],styleClass:e?"sapUiSizeCompact":"",onClose:function(e){if(e==="YES")this.onSave()}.bind(this)})},onSave:function(){var e=this.getModel("worklistView").getProperty("/aJourneys").sort(function(e,t){return e.Index-t.Index}).map(function(e){return e.Id}).join();this.getModel().callFunction("/SortPODInitiative",{urlParameters:{Ids:e},success:this._onSaveSuccess.bind(this),error:this._fnError.bind(this)})},_showObject:function(e){this.getRouter().navTo("object",{objectId:e.getBindingContext().getProperty("Id")})},_getListObject:function(){var e=this.byId("list").getSelectedContexts();return e.length===0?false:e[0]},_applySearch:function(e){var t=this.byId("table"),i=this.getModel("worklistView");t.getBinding("items").filter(e,"Application");if(e.length!==0){i.setProperty("/tableNoDataText",this.getResourceBundle().getText("worklistNoDataWithSearchText"))}},_fnError:function(e){var t=!!this.getView().$().closest(".sapUiSizeCompact").length;a.error(e.toString(),{styleClass:t?"sapUiSizeCompact":""})},_onSaveSuccess:function(){this.getModel("worklistView").setProperty("/bSave",false);var e=!!this.getView().$().closest(".sapUiSizeCompact").length;a.success(this.getResourceBundle().getText("MSG_SAVE_SUCCESS"),{styleClass:e?"sapUiSizeCompact":""})}})});