jQuery.sap.require("Assignment_List.Assignment_List.libs.mapsjs-core");jQuery.sap.require("Assignment_List.Assignment_List.libs.mapsjs-service");jQuery.sap.require("Assignment_List.Assignment_List.libs.mapsjs-ui");jQuery.sap.require("Assignment_List.Assignment_List.libs.mapsjs-mapevents");sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment"],function(e,t,i,s,o,n){"use strict";return e.extend("Assignment_List.Assignment_List.controller.Worklist",{formatter:i,onInit:function(){var e,i,s=this.byId("table"),o=this.byId("table1"),n=this.byId("table2"),r=this.byId("table3");i=s.getBusyIndicatorDelay();this._aTableSearchState=[];e=new t({worklistTableTitle:this.getResourceBundle().getText("worklistTableTitle"),saveAsTileTitle:this.getResourceBundle().getText("saveAsTileTitle",this.getResourceBundle().getText("worklistViewTitle")),shareOnJamTitle:this.getResourceBundle().getText("worklistTitle"),shareSendEmailSubject:this.getResourceBundle().getText("shareSendEmailWorklistSubject"),shareSendEmailMessage:this.getResourceBundle().getText("shareSendEmailWorklistMessage",[location.href]),tableNoDataText:this.getResourceBundle().getText("tableNoDataText"),tableBusyDelay:0,assigneeId:0,volunteerId:0,comments:"",Latitude:0,Longitude:0,POD_Longitude:"",POD_Latitude:"",EXPO_Longitude:"",EXPO_Latitude:""});this.setModel(e,"worklistView");var a=this;s.attachEventOnce("updateFinished",function(){e.setProperty("/tableBusyDelay",i);if(a.getOwnerComponent().isEmergency){a.getView().byId("filterbar").getAllFilterItems()[0].getControl().setSelectedKey(2);a.onSearch()}var t=a.getModel();t.callFunction("/GetLoggedInUser",{method:"GET",success:function(t){e.setProperty("/loggedUserId",t.results[0].Id);e.setProperty("/loggedUserRoleId",t.results[0].RoleId)}})});o.attachEventOnce("updateFinished1",function(){e.setProperty("/tableBusyDelay",i)});n.attachEventOnce("updateFinished2",function(){e.setProperty("/tableBusyDelay",i)});r.attachEventOnce("updateFinished3",function(){e.setProperty("/tableBusyDelay",i)});this.addHistoryEntry({title:this.getResourceBundle().getText("worklistViewTitle"),icon:"sap-icon://table-view",intent:"#AssignmentList-display"},true)},onUpdateFinished:function(e){var t,i=this,s,o=this.getModel("worklistView").getProperty("/selectedIncidentTypeId");if(o){s=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("IsArchived",sap.ui.model.FilterOperator.EQ,false),new sap.ui.model.Filter("AssignmentStatusId",sap.ui.model.FilterOperator.EQ,1),new sap.ui.model.Filter("ServiceType/IncidentTypeId",sap.ui.model.FilterOperator.EQ,o)],and:true})}else{s=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("IsArchived",sap.ui.model.FilterOperator.EQ,false),new sap.ui.model.Filter("AssignmentStatusId",sap.ui.model.FilterOperator.EQ,1)],and:true})}this.getModel().read("/AssignmentSet/$count",{filters:[s],async:true,success:function(e){t=i.getResourceBundle().getText("pendingCount",[e]);i.getModel("worklistView").setProperty("/pending",t)}})},onUpdateFinished1:function(e){var t,i=this,s,o=this.getModel("worklistView").getProperty("/selectedIncidentTypeId");if(o){s=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("IsArchived",sap.ui.model.FilterOperator.EQ,false),new sap.ui.model.Filter("AssignmentStatusId",sap.ui.model.FilterOperator.EQ,2),new sap.ui.model.Filter("ServiceType/IncidentTypeId",sap.ui.model.FilterOperator.EQ,o)],and:true})}else{s=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("IsArchived",sap.ui.model.FilterOperator.EQ,false),new sap.ui.model.Filter("AssignmentStatusId",sap.ui.model.FilterOperator.EQ,2)],and:true})}this.getModel().read("/AssignmentSet/$count",{filters:[s],async:true,success:function(e){t=i.getResourceBundle().getText("inprogressCount",[e]);i.getModel("worklistView").setProperty("/inprogress",t)}})},onUpdateFinished2:function(e){var t,i=this,s,o=this.getModel("worklistView").getProperty("/selectedIncidentTypeId");if(o){s=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("IsArchived",sap.ui.model.FilterOperator.EQ,false),new sap.ui.model.Filter("AssignmentStatusId",sap.ui.model.FilterOperator.EQ,3),new sap.ui.model.Filter("ServiceType/IncidentTypeId",sap.ui.model.FilterOperator.EQ,o)],and:true})}else{s=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("IsArchived",sap.ui.model.FilterOperator.EQ,false),new sap.ui.model.Filter("AssignmentStatusId",sap.ui.model.FilterOperator.EQ,3)],and:true})}this.getModel().read("/AssignmentSet/$count",{filters:[s],async:true,success:function(e){t=i.getResourceBundle().getText("completedCount",[e]);i.getModel("worklistView").setProperty("/completed",t)}})},onUpdateFinished3:function(e){var t,i=this,s,o=this.getModel("worklistView").getProperty("/selectedIncidentTypeId");if(o){s=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("IsArchived",sap.ui.model.FilterOperator.EQ,false),new sap.ui.model.Filter("AssignmentStatusId",sap.ui.model.FilterOperator.EQ,4),new sap.ui.model.Filter("ServiceType/IncidentTypeId",sap.ui.model.FilterOperator.EQ,o)],and:true})}else{s=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("IsArchived",sap.ui.model.FilterOperator.EQ,false),new sap.ui.model.Filter("AssignmentStatusId",sap.ui.model.FilterOperator.EQ,4)],and:true})}this.getModel().read("/AssignmentSet/$count",{filters:[s],async:true,success:function(e){t=i.getResourceBundle().getText("cancelledCount",[e]);i.getModel("worklistView").setProperty("/cancelled",t)}})},onPress:function(e){this._showObject(e.getSource())},onShareInJamPress:function(){var e=this.getModel("worklistView"),t=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:location.href,share:e.getProperty("/shareOnJamTitle")}}});t.open()},onRefreshView:function(){var e=this.getModel();e.refresh(true)},onAssignNow:function(e){var t=this.getView();var i=e.getSource().getBindingContext().getObject();this.getModel("worklistView").setProperty("/assigneeId",i.AssigneeId);this.getModel("worklistView").setProperty("/preAssigneeId",i.AssigneeId);var s=e.getSource().getBindingContext().getPath();var o=this.getModel().getData(s);this.getModel("worklistView").setProperty("/assignmentId",o.Id);if(!this.byId("openDialog")){n.load({id:t.getId(),name:"Assignment_List.Assignment_List.view.Dialog",controller:this}).then(function(e){t.addDependent(e);e.bindElement({path:s,model:"worklistView"});e.open()})}else{this.byId("openDialog").open()}},onStartAssignment:function(e){var t=this;var i=this.getView();var s=e.getSource().getBindingContext().getObject();this.getModel("worklistView").setProperty("/volunteerId",s.VolunteerId);var o=e.getSource().getBindingContext().getPath();var r=this.getModel().getData(o);this.getModel("worklistView").setProperty("/assignmentId",r.Id);if(!this.byId("openStartDialog")){n.load({id:i.getId(),name:"Assignment_List.Assignment_List.view.StartAssignment",controller:this}).then(function(e){i.addDependent(e);e.bindElement({path:o,model:"worklistView"});e.open();t.loadVolunteer()})}else{this.byId("openStartDialog").open();t.loadVolunteer()}},loadVolunteer:function(){var e=this.getModel("worklistView");var t=e.getProperty("/loggedUserId");var i=new s("ManagerId",o.EQ,t);var n=this.getView().byId("dropdown");var r=[new s("RoleId",o.EQ,4),new s("IsArchived",o.EQ,false),new s("IsAvailable",o.EQ,true),i];var a=new sap.ui.core.ListItem({text:"{FirstName} {LastName}",key:"{Id}"});n.bindAggregation("items",{path:"/UserSet",filters:r,template:a,templateShareable:false})},closeDialog:function(){this.byId("openDialog").close()},closeStartDialog:function(){this.byId("openStartDialog").close()},assignNow:function(){if(this.getModel("worklistView").getProperty("/assigneeId")===null){this.showToast.call(this,"MSG_ENTER_ASSIGNEE")}else{var e=this;var t=e.getModel();t.callFunction("/AssignNow",{method:"GET",urlParameters:{AssignmentId:this.getModel("worklistView").getProperty("/assignmentId"),AssigneeId:this.getModel("worklistView").getProperty("/assigneeId")},success:function(i){e.showToast.call(e,"MSG_SUCCESS_ASSIGNEE");e.byId("openDialog").close();t.refresh(true)}})}},startAssignNow:function(e){if(this.getModel("worklistView").getProperty("/volunteerId")===null){this.showToast.call(this,"MSG_ENTER_VOLUNTEER_ASSIGNEE")}else{var t=this;var i=t.getModel();i.callFunction("/StartAssignment",{method:"GET",urlParameters:{AssignmentId:this.getModel("worklistView").getProperty("/assignmentId"),VolunteerId:this.getModel("worklistView").getProperty("/volunteerId")},success:function(e){t.showToast.call(t,"MSG_SUCCESS_START_ASSIGNMENT");i.refresh(true);t.closeStartDialog()}})}},onMarkasComplete:function(e){var t=e.getSource().getBindingContext().getPath();var i=this.getModel().getData(t);var n=this;var r=n.getModel();var a=false;var l="/AssignmentSet";var d=[new s("AssignmentStatusId",o.EQ,2),new s("IsArchived",o.EQ,false)];n.getModel().read(l,{filters:d,success:function(e){if(e&&e.results.length){for(var t=0;t<e.results.length;t++){if(e.results[t].Id===i.Id){a=true;r.callFunction("/CompleteAssignment",{method:"GET",urlParameters:{AssignmentId:i.Id},success:function(e){n.showToast.call(n,"MSG_SUCCESS_MARKED_COMPLETED");r.refresh(true);return}})}}}if(a===false){n.showToast.call(n,"MSG_ERROR_REQUEST_ALREADY_CANCELLED");r.refresh(true)}},error:function(){n.showToast.call(n,"MSG_ERROR_REQUEST_ALREADY_CANCELLED");r.refresh(true)}})},onMessage:function(e){var t=this.getView();var i=e.getSource().getBindingContext().getPath();var s=this.getModel().getData(i);this.getModel("worklistView").setProperty("/userId",s.PODVisitorId);this.getModel("worklistView").setProperty("/message",null);if(!this.byId("messageDialog")){n.load({id:t.getId(),name:"Assignment_List.Assignment_List.view.MessageDialog",controller:this}).then(function(e){t.addDependent(e);e.bindElement({path:i,model:"worklistView"});e.open()})}else{this.byId("messageDialog").open()}},send:function(){var e=this.getModel("worklistView").getProperty("/message");if(e===null||e===""){this.showToast.call(this,"MSG_ENTER_MESSAGE")}else{var t=e.length;if(t>500){this.showToast.call(this,"MSG_EXCEEDED_LENGTH")}else{var i=this;var s=i.getModel();s.create("/UserMessageSet",{ReceiverId:this.getModel("worklistView").getProperty("/userId"),Message:this.getModel("worklistView").getProperty("/message")},{success:function(e){i.showToast.call(i,"MSG_SUCCESS_MESSAGE");i.byId("messageDialog").close();s.refresh(true)}})}}},closeMessageDialog:function(){this.byId("messageDialog").close()},onComment:function(e){var t=this.getView();var i=e.getSource().getBindingContext().getPath();var s=this.getModel().getData(i);this.getModel("worklistView").setProperty("/assignmentId",s.Id);var o=e.getSource().getBindingContext().getObject();this.getModel("worklistView").setProperty("/comments",o.Comments);if(!this.byId("commentDialog")){n.load({id:t.getId(),name:"Assignment_List.Assignment_List.view.CommentDialog",controller:this}).then(function(e){t.addDependent(e);e.bindElement({path:i,model:"worklistView"});e.open()})}else{this.byId("commentDialog").open()}},closeCommentDialog:function(){this.byId("commentDialog").close()},comment:function(){var e=this.getModel("worklistView").getProperty("/comments");if(e===null||e===""){this.showToast.call(this,"MSG_ENTER_COMMENT")}else{var t=e.length;if(t>500){this.showToast.call(this,"MSG_EXCEEDED_LENGTH")}else{var i=this;var s=i.getModel();s.callFunction("/CommentAssignment",{method:"GET",urlParameters:{AssignmentId:this.getModel("worklistView").getProperty("/assignmentId"),Comments:this.getModel("worklistView").getProperty("/comments")},success:function(e){i.showToast.call(i,"MSG_SUCCESS_COMMENT");i.byId("commentDialog").close();s.refresh(true)}})}}},onNavigate:function(e){var t=e.getSource().getBindingContext().getObject().PODVisitor.__ref;var i=this.getModel().getData("/"+t);this.getModel("worklistView").setProperty("/POD_Latitude",i.Latitude);this.getModel("worklistView").setProperty("/POD_Longitude",i.Longitude);var s=this;var o=e.getSource().getBindingContext().getObject();n.load({id:s.getView().getId(),type:"HTML",name:"Assignment_List.Assignment_List.dialog.HEREMaps",controller:s}).then(function(e){var t=new H.service.Platform({apikey:"BbN_bDCaLx6-5GZou8CHRvPWpf9CoDtVbMK4w-OTAxM"});var i=t.createDefaultLayers();var n=new H.Map(document.getElementById("map"),i.vector.normal.map,{zoom:15,center:{lng:s.getModel("appView").getProperty("/EXPO_Longitude"),lat:s.getModel("appView").getProperty("/EXPO_Latitude")}});var r=new H.mapevents.Behavior(new H.mapevents.MapEvents(n));var a=H.ui.UI.createDefault(n,i);s.calcRoute(t,n,o);s.getView().addDependent(e);e.open()}.bind(this))},onCloseMaps:function(){this.getView().byId("MapDialog").close();this.getView().byId("MapDialog").destroy()},addRouteShapeToMap:function(e,t){var i=new H.geo.LineString;var s=e.shape;var o;s.forEach(function(e){var t=e.split(",");i.pushLatLngAlt(t[0],t[1])});o=new H.map.Polyline(i,{style:{lineWidth:4,strokeColor:"rgba(0, 128, 255, 0.7)"}});t.addObject(o);t.getViewModel().setLookAtData({bounds:o.getBoundingBox()})},calcRoute:function(e,t,i){var s=this;var o=s.getModel("worklistView").getProperty("/POD_Latitude")+","+s.getModel("worklistView").getProperty("/POD_Longitude");var n=s.getModel("appView").getProperty("/EXPO_Latitude")+","+s.getModel("appView").getProperty("/EXPO_Longitude");var r=e.getRoutingService();var a={mode:"shortest;pedestrian",representation:"display",routeattributes:"waypoints,summary,shape,legs",maneuverattributes:"direction,action",waypoint0:n,waypoint1:o};function l(e){try{var i=e.response.route[0];s.addRouteShapeToMap(i,t);s.addManueversToMap(i,t)}catch(e){s.showToast("ERR_NO_ROUTE");console.log(e)}}r.calculateRoute(a,l.bind(s),l)},addManueversToMap:function(e,t){var i='<svg width="18" height="18" '+'xmlns="http://www.w3.org/2000/svg">'+'<circle cx="8" cy="8" r="8" '+'fill="#1b468d" stroke="white" stroke-width="1"  />'+"</svg>",s=new H.map.Icon(i,{anchor:{x:8,y:8}}),o=new H.map.Group,n,r;var a;for(n=0;n<e.leg.length;n+=1){for(r=0;r<e.leg[n].maneuver.length;r+=1){a=e.leg[n].maneuver[r];var l=new H.map.Marker({lat:a.position.latitude,lng:a.position.longitude},{icon:s});l.instruction=a.instruction;o.addObject(l)}}o.addEventListener("tap",function(e){t.setCenter(e.target.getGeometry());openBubble(e.target.getGeometry(),e.target.instruction)},false);t.addObject(o)},addDraggableMarker:function(e,t){var i=this.getModel("worklistView");var s=new H.map.Marker({lng:55.14711,lat:24.962762},{volatility:true});s.draggable=true;e.addObject(s);e.addEventListener("dragstart",function(i){var s=i.target,o=i.currentPointer;if(s instanceof H.map.Marker){var n=e.geoToScreen(s.getGeometry());s["offset"]=new H.math.Point(o.viewportX-n.x,o.viewportY-n.y);t.disable()}},false);e.addEventListener("dragend",function(e){var s=e.target;if(s instanceof H.map.Marker){t.enable();i.setProperty("/Longitude",s.getGeometry().lng.toString());i.setProperty("/Latitude",s.getGeometry().lat.toString())}},false);e.addEventListener("drag",function(t){var i=t.target,s=t.currentPointer;if(i instanceof H.map.Marker){i.setGeometry(e.screenToGeo(s.viewportX-i["offset"].x,s.viewportY-i["offset"].y))}},false)},onPodCategory:function(e){var t=e.getSource().getBindingContext().getPath(),i=e.getSource();if(!this._oPopover){n.load({name:"Assignment_List.Assignment_List.view.PODCategoryDialog",controller:this}).then(function(e){this._oPopover=e;this.getView().addDependent(this._oPopover);this._oPopover.bindElement(t);this._oPopover.openBy(i)}.bind(this))}else{this._oPopover.openBy(i);this._oPopover.bindElement(t)}},onDisplayContact:function(e){var t=e.getSource().getBindingContext().getPath(),i=e.getSource();if(!this._oPopover){n.load({name:"Assignment_List.Assignment_List.view.MobileNumberDialog",controller:this}).then(function(e){this._oPopover=e;this.getView().addDependent(this._oPopover);this._oPopover.bindElement(t);this._oPopover.openBy(i)}.bind(this))}else{this._oPopover.openBy(i);this._oPopover.bindElement(t)}},onCancelAssignment:function(e){var t=e.getSource().getBindingContext().getPath();var i=this.getModel().getData(t);var s=this;var o=s.getModel();o.callFunction("/CancelAssignment",{method:"GET",urlParameters:{AssignmentId:i.Id},success:function(e){s.showToast.call(s,"MSG_SUCCESS_MARKED_CANCELLED");o.refresh(true)}})},onSearch:function(){var e=this.getFiltersfromFB(),t=this.getView().byId("table"),i=this.getView().byId("table1"),s=this.getView().byId("table2"),o=this.getView().byId("table3");t.getBinding("items").filter(e);i.getBinding("items").filter(e);s.getBinding("items").filter(e);o.getBinding("items").filter(e);if(e.length!==0){this.getModel("worklistView").setProperty("/selectedIncidentTypeId",e[0].oValue1);this.getModel("worklistView").setProperty("/tableNoDataText",this.getResourceBundle().getText("worklistNoDataWithSearchText"))}else{this.getModel("worklistView").setProperty("/selectedIncidentTypeId",null)}},onRefresh:function(){var e=this.byId("table"),t=this.byId("table1"),i=this.byId("table2"),s=this.byId("table3");e.getBinding("items").refresh();t.getBinding("items").refresh();i.getBinding("items").refresh();s.getBinding("items").refresh()},getFiltersfromFB:function(){var e=this.getView().byId("filterbar"),t=[];e.getAllFilterItems().forEach(function(e){if(e.getControl().getSelectedKey()){t.push(new s(e.getName(),o.EQ,e.getControl().getSelectedKey()))}});return t},_showObject:function(e){this.getRouter().navTo("object",{objectId:e.getBindingContext().getProperty("Id")})},_applySearch:function(e){var t=this.byId("table"),i=this.byId("table1"),s=this.byId("table2"),o=this.byId("table3"),n=this.getModel("worklistView");t.getBinding("items").filter(e,"Application");i.getBinding("items").filter(e,"Application");s.getBinding("items").filter(e,"Application");o.getBinding("items").filter(e,"Application");if(e.length!==0){n.setProperty("/tableNoDataText",this.getResourceBundle().getText("worklistNoDataWithSearchText"))}}})});