sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/core/Fragment"],function(e,t,o,i){"use strict";return e.extend("com.coil.podway.MAFA.controller.Object",{onInit:function(){var e=new t({busy:true,oFiles:[]});this.setModel(e,"objectView");this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.getRouter().getRoute("createObject").attachPatternMatched(this._onCreateObjectMatched,this);this.getOwnerComponent().getModel().metadataLoaded().then(function(){e.setProperty("/busy",false)})},onAfterRendering:function(){this._initMessage()},onDelete:function(e){var t=this.getModel("objectView"),o=e.getParameter("listItem").getBindingContext("objectView"),i=+o.getPath().match(/(\d+)/)[0];if(t.getProperty("/sMode")==="E"&&o.getProperty("Id")){this._pendingDelOps.push(o.getProperty("Id"))}t.getProperty("/oFiles").splice(i,1);t.refresh()},onUpload:function(e){var t=e.getSource().FUEl.files[0],o=e.getSource();this.getImageBinary(t).then(this._fnAddFile.bind(this,o))},onMap:function(){var e=this;if(!this.getModel("appView").getProperty("/bHEREMapsLibLoaded"))this.loadHERELibs();if(e._oDlgAddOption){e.map.removeObject(e.marker);e.map.setCenter(e._getLocation(),true);e.addDraggableMarker(e.map,e.behavior,e._getLocation());e._oDlgAddOption.open();return}i.load({id:e.getView().getId(),type:"HTML",name:"com.coil.podway.MAFA.dialog.HEREMaps",controller:e}).then(function(t){e._oDlgAddOption=t;var o=this.getModel("objectView"),i=this._getLocation(),s=new H.service.Platform({apikey:"BbN_bDCaLx6-5GZou8CHRvPWpf9CoDtVbMK4w-OTAxM"});var a=s.createDefaultLayers();var r=new H.Map(document.getElementById("map"),a.vector.normal.map,{zoom:15,center:{lng:i.lng,lat:i.lat}});e.behavior=new H.mapevents.Behavior(new H.mapevents.MapEvents(r));var n=H.ui.UI.createDefault(r,a);e.map=r;e.getView().addDependent(t);e.addDraggableMarker(r,e.behavior,i);t.open()}.bind(this))},onCloseMaps:function(){this._oDlgAddOption.close()},_getLocation:function(){var e=this.getModel("objectView");if(+e.getProperty("/oDetails/Latitude")&&+e.getProperty("/oDetails/Longitude")){return{lat:+e.getProperty("/oDetails/Latitude"),lng:+e.getProperty("/oDetails/Longitude")}}return{lat:+this.getModel("appView").getProperty("/EventLocation/lat"),lng:+this.getModel("appView").getProperty("/EventLocation/lng")}},onShareInJamPress:function(){var e=this.getModel("objectView"),t=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:location.href,share:e.getProperty("/shareOnJamTitle")}}});t.open()},onSave:function(){var e=this.getModel("objectView");var t=e.getProperty("/oDetails"),o=this._fnValidation(t);if(o.IsNotValid){this.showError(this._fnMsgConcatinator(o.sMsg));return}e.setProperty("/busy",true);this.CUOperation(t).then(this._fnUploadImages.bind(this,e))},onCancel:function(){this.getRouter().navTo("worklist",true)},_onObjectMatched:function(e){this.getModel("objectView").setProperty("/sMode","E");this.getModel("objectView").setProperty("/busy",true);var t=e.getParameter("arguments").objectId;this.getModel().metadataLoaded().then(function(){var e=this.getModel().createKey("/FacilitySet",{Id:t});this.getModel().read(e,{urlParameters:{$expand:"Images"},success:this._setView.bind(this)})}.bind(this))},_onCreateObjectMatched:function(){this.getModel("objectView").setProperty("/sMode","C");this.getModel("objectView").setProperty("/busy",true);this._setView()},_setView:function(e){this._oMessageManager.removeAllMessages();var t=this.getModel("objectView");t.setProperty("/busy",false);this._pendingDelOps=[];if(e){t.setProperty("/oFiles",e.Images.results);t.setProperty("/oDetails",e);return}t.setProperty("/oFiles",[]);t.setProperty("/oDetails",{BuildingId:null,FacilityTypeId:"",Latitude:"",Longitude:"",IsArchived:false,Description:""})},_fnAddFile:function(e,t){var o=t.Image.search(",")+1;var i={Image:t.Image.slice(o),FileName:t.name,FileType:"image/png",IsArchived:false};this.getModel("objectView").getProperty("/oFiles").push(i);e.clear();this.getModel("objectView").refresh()},_initMessage:function(){var e=this.getModel("objectView");this._oMessageManager=sap.ui.getCore().getMessageManager();this._oMessageManager.registerMessageProcessor(e)},_fnValidation:function(e){this._oMessageManager.removeAllMessages();var t={IsNotValid:false,sMsg:[]},o=[];if(!e.FacilityTypeId){t.IsNotValid=true;t.sMsg.push("MSG_VALDTN_ERR_FAC");o.push({message:"MSG_VALDTN_ERR_FAC",target:"/oDetails/FacilityTypeId"})}if(!e.Description){t.IsNotValid=true;t.sMsg.push("MSG_VALDTN_ERR_DES");o.push({message:"MSG_VALDTN_ERR_DES",target:"/oDetails/Description"})}if(+e.Longitude==0||+e.Latitude==0){t.IsNotValid=true;t.sMsg.push("MSG_LAT_LNG");o.push({message:"MSG_LAT_LNG",target:"/oDetails/Latitude"});o.push({message:"MSG_LAT_LNG",target:"/oDetails/Longitude"})}else if(+e.Latitude<-90||+e.Latitude>90){t.IsNotValid=true;t.sMsg.push("MSG_ERR_LAT");o.push({message:"MSG_ERR_LAT",target:"/oDetails/Latitude"})}else if(+e.Longitude<-180||+e.Longitude>180){t.IsNotValid=true;t.sMsg.push("MSG_ERR_LNG");o.push({message:"MSG_ERR_LNG",target:"/oDetails/Longitude"})}if(o.length)this._genCtrlMessages(o);return t},_genCtrlMessages:function(e){var t=this,o=t.getModel("objectView");e.forEach(function(e){t._oMessageManager.addMessages(new sap.ui.core.message.Message({message:t.getResourceBundle().getText(e.message),type:sap.ui.core.MessageType.Error,target:e.target,processor:o,persistent:true}))})},_fnMsgConcatinator:function(e){var t=this;return e.map(function(e){return t.getResourceBundle().getText(e)}).join("\n")},addDraggableMarker:function(e,t,o){var i=this.getModel("objectView");var s=new H.map.Marker({lng:o.lng,lat:o.lat},{volatility:true});s.draggable=true;this.marker=s;e.addObject(s);e.addEventListener("dragstart",function(o){var i=o.target,s=o.currentPointer;if(i instanceof H.map.Marker){var a=e.geoToScreen(i.getGeometry());i["offset"]=new H.math.Point(s.viewportX-a.x,s.viewportY-a.y);t.disable()}},false);e.addEventListener("dragend",function(e){var o=e.target;if(o instanceof H.map.Marker){t.enable();i.setProperty("/oDetails/Longitude",o.getGeometry().lng.toString());i.setProperty("/oDetails/Latitude",o.getGeometry().lat.toString())}},false);e.addEventListener("drag",function(t){var o=t.target,i=t.currentPointer;if(o instanceof H.map.Marker){o.setGeometry(e.screenToGeo(i.viewportX-o["offset"].x,i.viewportY-o["offset"].y))}},false)},CUOperation:function(e){var t=this.getModel("objectView");delete e.FacilityType;delete e.Images;var o=$.extend(true,{},e),i=this;o.BuildingId=+o.BuildingId;return new Promise(function(e,s){if(t.getProperty("/sMode")==="E"){var a=i.getModel().createKey("/FacilitySet",{Id:o.Id});i.getModel().update(a,o,{success:function(){t.setProperty("/busy",false);i.showToast.call(i,"MSG_SUCCESS_UPDATE");e(o)},error:function(){t.setProperty("/busy",false);s()}})}else{o.FacilityTypeId=+o.FacilityTypeId;i.getModel().create("/FacilitySet",o,{success:function(o){t.setProperty("/busy",false);i.showToast.bind(i,"MSG_SUCCESS_CREATE");e(o)},error:function(){t.setProperty("/busy",false);s()}})}})},_fnUploadImages:function(e,t){var o=e.getProperty("/oFiles"),i=[],s=this,a=e.getProperty("/sModel")==="C"?t.Id:e.getProperty("/oDetails/Id");o.forEach(function(e){if(e.Id===undefined){e.FacilityId=a;i.push(s._fnUploadFile(e))}});if(this._pendingDelOps.length){this._pendingDelOps.forEach(function(e){i.push(s._fnDeleteFile.call(s,e))})}e.setProperty("/busy",true);Promise.all(i).then(function(){e.setProperty("/busy",false);s.showToast("MSG_SUCCESS_IMG_UPLAOD");s.onCancel.call(s)})},_fnDeleteFile:function(e){var t=this;return new Promise(function(o,i){var s=t.getModel().createKey("/FacilityImageSet",{Id:e});t.getModel().update(s,{IsArchived:true},{success:function(){o()}})})},_fnUploadFile:function(e){var t=this;return new Promise(function(o,i){t.getModel().create("/FacilityImageSet",e,{success:function(){o()}})})},loadHERELibs:function(){this.getModel("appView").setProperty("/bHEREMapsLibLoaded",true);jQuery.sap.require("com.coil.podway.MAFA.libs.mapsjs-core");jQuery.sap.require("com.coil.podway.MAFA.libs.mapsjs-service");jQuery.sap.require("com.coil.podway.MAFA.libs.mapsjs-ui");jQuery.sap.require("com.coil.podway.MAFA.libs.mapsjs-mapevents")}})});