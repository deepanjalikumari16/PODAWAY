sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment"],function(e,t,i,s,o,a){"use strict";return e.extend("com.coil.podway.MAEVAT.controller.Worklist",{formatter:i,onInit:function(){var e,i,s=this.byId("table");i=s.getBusyIndicatorDelay();this._aTableSearchState=[];e=new t({worklistTableTitle:this.getResourceBundle().getText("worklistTableTitle"),saveAsTileTitle:this.getResourceBundle().getText("saveAsTileTitle",this.getResourceBundle().getText("worklistViewTitle")),shareOnJamTitle:this.getResourceBundle().getText("worklistTitle"),shareSendEmailSubject:this.getResourceBundle().getText("shareSendEmailWorklistSubject"),shareSendEmailMessage:this.getResourceBundle().getText("shareSendEmailWorklistMessage",[location.href]),tableNoDataText:this.getResourceBundle().getText("tableNoDataText"),tableBusyDelay:0,iEvtType:1});this.setModel(e,"worklistView");s.attachEventOnce("updateFinished",function(){e.setProperty("/tableBusyDelay",i)});this.getOwnerComponent().getModel().metadataLoaded().then(this._fnInitialBindings.bind(this));this._setSearchField()},onUpdateFinished:function(e){var t,i=e.getSource(),s=e.getParameter("total");if(s&&i.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("worklistTableTitleCount"+this.getModel("worklistView").getProperty("/iEvtType"),[s])}else{t=this.getResourceBundle().getText("worklistTableTitle"+this.getModel("worklistView").getProperty("/iEvtType"))}this.getModel("worklistView").setProperty("/worklistTableTitle",t)},onShareInJamPress:function(){var e=this.getModel("worklistView"),t=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:location.href,share:e.getProperty("/shareOnJamTitle")}}});t.open()},onViewImage:function(e,t){var i=this.getView(),s=this;s.oImageBindingContext=e.getSource().getBindingContext();if(!s._oDlgAddOption){a.load({id:i.getId(),name:"com.coil.podway.MAEVAT.dialog.Images",controller:s}).then(function(e){s._oDlgAddOption=e;i.addDependent(e);e.open()})}else{s._oDlgAddOption.open()}this.getModel("worklistView").setProperty("/sDialog",t)},bindDialog:function(){var e=this,t=this.getModel("worklistView"),i=t.getProperty("/sDialog");this._oDlgAddOption.getContent()[0].bindAggregation("pages",{path:i==="I"?"/EventAttractionImageSet":"/EventAttractionPlanSet",filters:[new s("IsArchived",o.EQ,false),new s("EventAttractionId",o.EQ,e.oImageBindingContext.getProperty("Id"))],template:new sap.m.Image({src:{path:"__metadata",formatter:e.formatter.giveImage}}),events:{dataRequested:function(){t.setProperty("/bLoadingImages",true)},dataReceived:function(e){t.setProperty("/bLoadingImages",false);if(e.getParameter("data").results.length){t.setProperty("/bImages",true)}else{t.setProperty("/bImages",false)}}}})},onCancelImage:function(){this._oDlgAddOption.close()},onSearch:function(e){var t=this.getFiltersfromFB(),i=this.getView().byId("table");var a=e.getSource().getBasicSearchValue();if(a&&a.length>0){t.push(new s({path:"Name",operator:o.Contains,value1:a,caseSensitive:false}))}i.getBinding("items").filter(t);if(t.length!==0){this.getModel("worklistView").setProperty("/tableNoDataText",this.getResourceBundle().getText("worklistNoDataWithSearchText"))}},onBasicSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh()}else{var t=[];var i=e.getParameter("query");if(i&&i.length>0){t=[new s("Title",o.Contains,i)]}this._applySearch(t)}},onRefresh:function(){var e=this.byId("table");e.getBinding("items").refresh()},onAdd:function(){this._setPrefilledAttarctionType();this.getRouter().navTo("createObject")},onEdit:function(e){this._showObject(e.getSource())},onDelete:function(e){var t=e.getSource().getBindingContext().getPath();function i(){this.getModel().update(t,{IsArchived:true},{success:this._fnSuccessToast.bind(this,"MSG_SUCC_EVT_DEL")})}this.showWarning("MSG_CONF_DEL",i)},_fnInitialBindings:function(){var e=this.byId("table"),t=e.getItems()[0].clone();this.getModel("worklistView").setProperty("/iEvtType",this.getOwnerComponent().iEvtType);e.bindItems({template:t,path:"/EventAttractionSet",parameters:{expand:"Theme,EventAttractionType,Building,AccessibilityDevices"},sorter:[new sap.ui.model.Sorter("Name")],events:{dataRequested:this._fnbusyItems.bind(this),dataReceived:this._fnbusyItems.bind(this)},filters:[new s("EventAttractionTypeId",this.getModel("worklistView").getProperty("/iEvtType")==1?o.EQ:o.NE,1),new s("IsArchived",o.EQ,false)],templateShareable:true})},getFiltersfromFB:function(){var e=this.getView().byId("filterbar"),t=[];e.getAllFilterItems().forEach(function(e){if(e.getControl().getSelectedKey()){t.push(new s(e.getName(),o.EQ,e.getControl().getSelectedKey()))}});return t},_showObject:function(e){this.getRouter().navTo("object",{objectId:e.getBindingContext().getProperty("Id")})},_applySearch:function(e){var t=this.byId("table"),i=this.getModel("worklistView");t.getBinding("items").filter(e,"Application");if(e.length!==0){i.setProperty("/tableNoDataText",this.getResourceBundle().getText("worklistNoDataWithSearchText"))}},_fnbusyItems:function(e){var t=this.getModel("worklistView");if(e.getId()==="dataRequested"){t.setProperty("/bTableBusy",true)}else{t.setProperty("/bTableBusy",false)}},_setPrefilledAttarctionType:function(){var e=this.getView().byId("filterbar");this.getModel("appView").setProperty("/prefilledType",e.getAllFilterItems()[0].getControl().getSelectedKey())},_setSearchField:function(e){var t=this.getView().byId("filterbar").getBasicSearch();var i;if(!t){i=new sap.m.SearchField({showSearchButton:false})}else{t=null}this.getView().byId("filterbar").setBasicSearch(i);i.attachBrowserEvent("keyup",function(e){if(e.which===13){this.getView().byId("filterbar").fireSearch()}}.bind(this))}})});