sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,i,s,a,o){"use strict";return e.extend("com.coil.podway.MAEVAT.controller.Object",{formatter:i,onInit:function(){var e,i=new t({busy:true,delay:0,sMode:"C"});this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.getRouter().getRoute("createObject").attachPatternMatched(this._onCreateObjectMatched,this);e=this.getView().getBusyIndicatorDelay();this.setModel(i,"objectView");this.getOwnerComponent().getModel().metadataLoaded().then(function(){i.setProperty("/delay",e)})},onAfterRendering:function(){this._initMessage();var e=this;debugger;this.getOwnerComponent().getModel().metadataLoaded().then(function(){e._setAttarctionTypeCtrl.call(e)})},onUpload:function(e){var t=e.getSource().FUEl.files[0],i=e.getSource();this.getImageBinary(t).then(this._fnAddFile.bind(this,i))},onDelete:function(e){var t=this.getModel("objectView"),i=e.getParameter("listItem").getBindingContext("objectView"),s=+i.getPath().match(/(\d+)/)[0];if(t.getProperty("/sMode")==="E"&&i.getProperty("Id")!==undefined){this._pendingDelOps.push(i.getProperty("Id"))}t.getProperty("/oImages").splice(s,1);t.refresh()},onDelTheme:function(){this.getModel("objectView").setProperty("/oDetails/ThemeId",null)},onMap:function(){if(!this.getModel("appView").getProperty("/bHEREMapsLibLoaded"))this.loadHERELibs();var e=this,t=this.getModel("objectView");if(e._oDlgAddOption){if(e.marker)e.map.removeObject(e.marker);e.map.setCenter(e._getLocation(),true);e.addDraggableMarker(e.map,e.behavior,e._getLocation());e._oDlgAddOption.open();return}s.load({id:e.getView().getId(),type:"HTML",name:"com.coil.podway.MAEVAT.dialog.HEREMaps",controller:e}).then(function(t){e._oDlgAddOption=t;var i=this._getLocation(),s=new H.service.Platform({apikey:"BbN_bDCaLx6-5GZou8CHRvPWpf9CoDtVbMK4w-OTAxM"});var a=s.createDefaultLayers();var o=new H.Map(document.getElementById("map"),a.vector.normal.map,{zoom:15,center:{lng:i.lng,lat:i.lat}});e.behavior=new H.mapevents.Behavior(new H.mapevents.MapEvents(o));var r=H.ui.UI.createDefault(o,a);e.map=o;e.getView().addDependent(t);e.addDraggableMarker(o,e.behavior,i);t.open()}.bind(this))},onCloseMaps:function(){this._oDlgAddOption.close()},onShareInJamPress:function(){var e=this.getModel("objectView"),t=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:location.href,share:e.getProperty("/shareOnJamTitle")}}});t.open()},onSave:function(){var e=this.getModel("objectView"),t=$.extend(true,{},e.getProperty("/oDetails"));var i=this._fnValidate(t);if(i.IsNotValid){this.showErrorMessageBox(this._fnMsgConcatinator(i.sMsg));return}function s(){e.setProperty("/busy",false)}t.AvoidablePlaces=t.AvoidablePlaces.map(function(e){return{Id:e}});t.AccessibilityDevices=t.AccessibilityDevices.map(function(e){return{Id:e}});t.Categories=t.Categories.map(function(e){return{Id:e}});e.setProperty("/busy",true);this._fnCallMainSet(t,e.getProperty("/sMode")==="C").then(this._fnUploadFiles.bind(this),s)},onCancel:function(){this.getRouter().navTo("worklist",true)},onDeletePlan:function(){var e=this.getModel("objectView");if(e.getProperty("/oPlan")&&e.getProperty("/oPlan/Id")!==undefined){this._delPlanId=e.getProperty("/oPlan/Id")}e.setProperty("/oPlan",null)},onLnkPlan:function(){},onAddHighlight:function(){var e=this.getModel("objectView");if(!e.getProperty("/oDetails/Highlights"))e.setProperty("/oDetails/Highlights",[]);e.getProperty("/oDetails/Highlights").push({Highlight:"",EventAttractionId:e.getProperty("/oDetails/Id"),IsArchived:false});e.refresh()},onComboBoxChange:function(e){if(e.getParameter("itemPressed")===false){e.getSource().setValue("")}},onDelHighlight:function(e){var t=this.getModel("objectView");t.setProperty("IsArchived",true,e.getParameter("listItem").getBindingContext("objectView"));t.refresh(true)},_onObjectMatched:function(e){this.getModel("objectView").setProperty("/sMode","E");this.getModel("objectView").setProperty("/busy",true);var t=e.getParameter("arguments").objectId;this.getModel().metadataLoaded().then(function(){var e=this.getModel().createKey("/EventAttractionSet",{Id:t});this.getModel().read(e,{urlParameters:{$expand:"Images,Categories,AvoidablePlaces,Plans,AccessibilityDevices,Highlights"},success:this._setView.bind(this)})}.bind(this))},addDraggableMarker:function(e,t,i){var s=this.getModel("objectView");var a=new H.map.Marker({lng:i.lng,lat:i.lat},{volatility:true});a.draggable=true;this.marker=a;e.addObject(a);e.addEventListener("dragstart",function(i){var s=i.target,a=i.currentPointer;if(s instanceof H.map.Marker){var o=e.geoToScreen(s.getGeometry());s["offset"]=new H.math.Point(a.viewportX-o.x,a.viewportY-o.y);t.disable()}},false);e.addEventListener("dragend",function(e){var i=e.target;if(i instanceof H.map.Marker){t.enable();s.setProperty("/oDetails/Longitude",i.getGeometry().lng.toString());s.setProperty("/oDetails/Latitude",i.getGeometry().lat.toString())}},false);e.addEventListener("drag",function(t){var i=t.target,s=t.currentPointer;if(i instanceof H.map.Marker){i.setGeometry(e.screenToGeo(s.viewportX-i["offset"].x,s.viewportY-i["offset"].y))}},false)},_setView:function(e){this._oMessageManager.removeAllMessages();this._pendingDelOps=[];this._delPlanId="";this.coverImageId=null;var t=this.getModel("objectView");t.setProperty("/busy",false);if(e){t.setProperty("/oImages",e.Images.results);t.setProperty("/oPlan",e.Plans.results[0]===undefined?null:e.Plans.results[0]);if(e.AccessibilityDevices.hasOwnProperty("results"))e.AccessibilityDevices=e.AccessibilityDevices.results.map(function(e){return e.Id});else e.AccessibilityDevices=[];if(e.AvoidablePlaces.hasOwnProperty("results"))e.AvoidablePlaces=e.AvoidablePlaces.results.map(function(e){return e.Id});else e.AvoidablePlaces=[];e.Categories=e.Categories.results.map(function(e){return e.Id});e.Highlights=e.Highlights.results;t.setProperty("/oDetails",e);return}t.setProperty("/oImages",[]);t.setProperty("/oPlan",null);t.setProperty("/oDetails",{BuildingId:null,EventAttractionTypeId:this.getModel("appView").getProperty("/prefilledType"),Latitude:+this.getModel("appView").getProperty("/EventLocation/lat"),Longitude:+this.getModel("appView").getProperty("/EventLocation/lng"),IsArchived:false,Description:"",AccessibilityDevices:[],AssistiveDevices:[],AvoidablePlaces:[],Categories:[],Title:"",Name:"",ReferenceLink:"",ThemeId:null,Highlights:[]})},_onCreateObjectMatched:function(){this.getModel("objectView").setProperty("/sMode","C");this.getModel("objectView").setProperty("/busy",true);this._setView()},_fnAddFile:function(e,t){var i=t.Image.search(",")+1;if(e.getButtonOnly()){var s={Image:t.Image.slice(i),FileName:t.name,FileType:"image/png",IsArchived:false,IsCoverImage:false};this.getModel("objectView").getProperty("/oImages").push(s)}else{this.getModel("objectView").setProperty("/oPlan",{Plan:t.Image.slice(i),FileName:t.name,IsArchived:false})}e.clear();this.getModel("objectView").refresh()},_fnCallMainSet:function(e,t){var i=t,s=e;var a=this;return new Promise(function(e,t){if(i){a.getModel().create("/EventAttractionSet",s,{success:function(t){e(t)},error:function(){t()}})}else{delete s.Plans;delete s.Images;delete s.EventAttractionType;delete s.HighlightsTitle;delete s.__metadata;delete s.UpdatedAt;delete s.CreatedAt;var o=a.getModel().createKey("/EventAttractionSet",{Id:s.Id});a.getModel().update(o,s,{success:function(){e(s)},error:function(){t()}})}})},_fnUploadFiles:function(e){var t=[],i=this,s=this.getModel(),a=this.getModel("objectView"),o=null;if(this._pendingDelOps.length){this._pendingDelOps.forEach(function(e){t.push(i._fnDelOp(s,"/EventAttractionImageSet",e))})}if(this._delPlanId.length){t.push(i._fnDelOp(s,"/EventAttractionPlanSet",this._delPlanId))}a.getProperty("/oImages").forEach(function(s){s.EventAttractionId=e.Id;if(s.Id===undefined){t.push(i._fnCrOp.call(i,"/EventAttractionImageSet",s))}else{o=s.IsCoverImage&&!s.IsArchived?s.Id:o}});if(a.getProperty("/oPlan")&&a.getProperty("/oPlan/Id")===undefined){var r=a.getProperty("/oPlan");r.EventAttractionId=e.Id;t.push(i._fnCrOp.call(i,"/EventAttractionPlanSet",r))}Promise.all(t).then(function(t){return new Promise(function(t,i){if(o){s.callFunction("/UpdateEventAttractionCoverImage",{urlParameters:{ImageId:+o,EventAttactionId:+e.Id},success:function(){t()},error:function(){i()}})}else{t()}})}).then(function(){a.setProperty("/busy",false);i._fnSuccessToast.call(i,"MSG_SUCCESS_EVENTDETAILS");i.onCancel.apply(i)},function(){a.setProperty("/busy",false)})},_fetchCoverImages:function(e){var t=this;return new Promise(function(i,s){var a=t.getModel().createKey("/EventAttractionSet",{Id:e});t.getModel().read(a,{urlParameters:{$expand:"Images",$select:"Images"},success:function(e){i(e)}})})},_fnDelOp:function(e,t,i){var s=t,a=i,o=e;return new Promise(function(e,t){var i=o.createKey(s,{Id:a});o.update(i,{IsArchived:true},{success:function(){e()},error:function(){t()}})})},_fnCrOp:function(e,t){var i=this,s=e,a=t;return new Promise(function(e,t){i.getModel().create(s,a,{success:function(t){i.coverImageId=t.IsCoverImage?t.Id:i.coverImageId;e()},error:function(){t()}})})},_getLocation:function(){var e=this.getModel("objectView");if(+e.getProperty("/oDetails/Latitude")&&+e.getProperty("/oDetails/Longitude")){return{lat:+e.getProperty("/oDetails/Latitude"),lng:+e.getProperty("/oDetails/Longitude")}}return{lat:+this.getModel("appView").getProperty("/EventLocation/lat"),lng:+this.getModel("appView").getProperty("/EventLocation/lng")}},_initMessage:function(){var e=this.getModel("objectView");this._oMessageManager=sap.ui.getCore().getMessageManager();this._oMessageManager.registerMessageProcessor(e)},_genCtrlMessages:function(e){var t=this,i=t.getModel("objectView");e.forEach(function(e){t._oMessageManager.addMessages(new sap.ui.core.message.Message({message:t.getResourceBundle().getText(e.message),type:sap.ui.core.MessageType.Error,target:e.target,processor:i,persistent:true}))})},_fnValidate:function(e){this._oMessageManager.removeAllMessages();var t={IsNotValid:false,sMsg:[]},i=[];if(!e.EventAttractionTypeId){t.IsNotValid=true;t.sMsg.push("ERR_TYPE_ERROR");i.push({message:"ERR_TYPE_ERROR",target:"/oDetails/EventAttractionTypeId"})}if(!e.Title.length){t.IsNotValid=true;t.sMsg.push("MSG_ERR_TITLE");i.push({message:"MSG_ERR_TITLE",target:"/oDetails/Title"})}if(!e.Name.length){t.IsNotValid=true;t.sMsg.push("MSG_ERR_NAME");i.push({message:"MSG_ERR_NAME",target:"/oDetails/Name"})}if(!e.Description.length){t.IsNotValid=true;t.sMsg.push("MSG_ERR_DSC");i.push({message:"MSG_ERR_DSC",target:"/oDetails/Description"})}if(e.EventAttractionTypeId!==2){if(+e.Longitude==0||+e.Latitude==0){t.IsNotValid=true;t.sMsg.push("MSG_LAT_LNG");i.push({message:"MSG_LAT_LNG",target:"/oDetails/Longitude"});i.push({message:"MSG_LAT_LNG",target:"/oDetails/Latitude"})}else if(+e.Latitude<-90||+e.Latitude>90){t.IsNotValid=true;t.sMsg.push("MSG_ERR_LAT");i.push({message:"MSG_ERR_LAT",target:"/oDetails/Latitude"})}else if(+e.Longitude<-180||+e.Longitude>180){t.IsNotValid=true;t.sMsg.push("MSG_ERR_LNG");i.push({message:"MSG_ERR_LNG",target:"/oDetails/Longitude"})}}if(e.EventAttractionTypeId===2&&(+e.Latitude<-90||+e.Latitude>90)){t.IsNotValid=true;t.sMsg.push("MSG_ERR_LAT");i.push({message:"MSG_ERR_LAT",target:"/oDetails/Latitude"})}else if(e.EventAttractionTypeId===2&&(+e.Longitude<-180||+e.Longitude>180)){t.IsNotValid=true;t.sMsg.push("MSG_ERR_LNG");i.push({message:"MSG_ERR_LNG",target:"/oDetails/Longitude"})}var s=/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/;var a=e.ReferenceLink;if(e.EventAttractionTypeId===2&&(!!e.ReferenceLink&&e.ReferenceLink.length>0&&!a.match(s))){t.IsNotValid=true;t.sMsg.push("ERR_Invalid_link");i.push({message:"ERR_Invalid_link",target:"/oDetails/ReferenceLink"})}if(i.length)this._genCtrlMessages(i);return t},_fnMsgConcatinator:function(e){var t=this;return e.map(function(e){return t.getResourceBundle().getText(e)}).join("\n")},_setAttarctionTypeCtrl:function(){var e=this.getView().byId("dpAttarctiontype");e.bindItems({path:"/MasterEventAttractionTypeSet",filters:[new a("IsArchived",o.EQ,false),new a("Id",this.getOwnerComponent().iEvtType===1?o.EQ:o.NE,1)],template:new sap.ui.core.Item({key:"{Id}",text:"{EventAttractionType}"})})},loadHERELibs:function(){this.getModel("appView").setProperty("/bHEREMapsLibLoaded",true);jQuery.sap.require("com.coil.podway.MAEVAT.libs.mapsjs-core");jQuery.sap.require("com.coil.podway.MAEVAT.libs.mapsjs-service");jQuery.sap.require("com.coil.podway.MAEVAT.libs.mapsjs-ui");jQuery.sap.require("com.coil.podway.MAEVAT.libs.mapsjs-mapevents")}})});